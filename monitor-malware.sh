#!/bin/bash

echo "üîç Surveillance du malware MoneroOcean"
echo "====================================="
echo ""

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

THREAT_DETECTED=0

# 1. V√©rifier les processus
echo -e "${YELLOW}1Ô∏è‚É£ Processus suspects:${NC}"
PROCESSES=$(ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep || true)
if [ -n "$PROCESSES" ]; then
    echo -e "   ${RED}‚ö†Ô∏è  THREAT DETECTED !${NC}"
    echo "$PROCESSES" | sed 's/^/      /'
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}‚úÖ Aucun processus suspect${NC}"
fi

# 2. V√©rifier les dossiers
echo ""
echo -e "${YELLOW}2Ô∏è‚É£ Dossiers suspects:${NC}"
SUSPECT_DIRS=(
    "$HOME/moneroocean"
    "$HOME/xmrig"
    "/tmp/moneroocean"
    "/var/tmp/moneroocean"
)

for dir in "${SUSPECT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "   ${RED}‚ö†Ô∏è  THREAT DETECTED: $dir existe !${NC}"
        THREAT_DETECTED=1
    fi
done

if [ $THREAT_DETECTED -eq 0 ]; then
    echo -e "   ${GREEN}‚úÖ Aucun dossier suspect${NC}"
fi

# 3. V√©rifier les crontabs
echo ""
echo -e "${YELLOW}3Ô∏è‚É£ Crontabs suspects:${NC}"
CRON_SUSPECT=$(crontab -l 2>/dev/null | grep -E "(xmrig|moneroocean|miner|wget.*sh|curl.*sh)" || true)
if [ -n "$CRON_SUSPECT" ]; then
    echo -e "   ${RED}‚ö†Ô∏è  THREAT DETECTED dans crontab !${NC}"
    echo "$CRON_SUSPECT" | sed 's/^/      /'
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}‚úÖ Crontab propre${NC}"
fi

# 4. V√©rifier la m√©moire
echo ""
echo -e "${YELLOW}4Ô∏è‚É£ Utilisation de la m√©moire:${NC}"
MEM_INFO=$(free -h | grep Mem)
MEM_USED=$(echo $MEM_INFO | awk '{print $3}')
MEM_TOTAL=$(echo $MEM_INFO | awk '{print $2}')
MEM_PERCENT=$(free | grep Mem | awk '{printf "%.0f", ($3/$2) * 100}')

if [ "$MEM_PERCENT" -gt 90 ]; then
    echo -e "   ${RED}‚ö†Ô∏è  M√©moire tr√®s utilis√©e: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
    THREAT_DETECTED=1
elif [ "$MEM_PERCENT" -gt 80 ]; then
    echo -e "   ${YELLOW}‚ö†Ô∏è  M√©moire √©lev√©e: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
else
    echo -e "   ${GREEN}‚úÖ M√©moire OK: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
fi

# 5. V√©rifier les services systemd
echo ""
echo -e "${YELLOW}5Ô∏è‚É£ Services systemd suspects:${NC}"
SERVICES=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" || true)
if [ -n "$SERVICES" ]; then
    echo -e "   ${RED}‚ö†Ô∏è  THREAT DETECTED !${NC}"
    echo "$SERVICES" | sed 's/^/      /'
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}‚úÖ Aucun service suspect${NC}"
fi

# R√©sum√©
echo ""
echo "====================================="
if [ $THREAT_DETECTED -eq 1 ]; then
    echo -e "${RED}‚ö†Ô∏è  MENACE D√âTECT√âE !${NC}"
    echo ""
    echo "Ex√©cutez le script de nettoyage:"
    echo "   bash cleanup-malware-complete.sh"
    exit 1
else
    echo -e "${GREEN}‚úÖ Aucune menace d√©tect√©e${NC}"
    exit 0
fi
