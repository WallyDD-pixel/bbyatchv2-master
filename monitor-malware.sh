#!/bin/bash

# Script de surveillance et suppression automatique du malware
LOG_FILE="/var/log/malware-protection.log"

# Fonction de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | sudo tee -a "$LOG_FILE" > /dev/null
}

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

THREAT_DETECTED=0
FILES_REMOVED=0
PROCESSES_KILLED=0

# 1. Vérifier et tuer les processus suspects
echo -e "${YELLOW}1️⃣ Processus suspects:${NC}"
PROCESSES=$(ps aux | grep -E "(xmrig|moneroocean|miner|scanner_linux|systemwatcher)" | grep -v grep || true)
if [ -n "$PROCESSES" ]; then
    echo -e "   ${RED}⚠️  THREAT DETECTED !${NC}"
    echo "$PROCESSES" | sed 's/^/      /'
    log "ALERTE: Processus malveillant détecté"
    
    # Tuer automatiquement les processus
    pkill -9 -f xmrig 2>/dev/null && log "Processus xmrig tué" && PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
    pkill -9 -f moneroocean 2>/dev/null && log "Processus moneroocean tué" && PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
    pkill -9 -f miner 2>/dev/null && log "Processus miner tué" && PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
    pkill -9 -f scanner_linux 2>/dev/null && log "Processus scanner_linux tué" && PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
    pkill -9 -f systemwatcher 2>/dev/null && log "Processus systemwatcher tué" && PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
    
    echo -e "   ${GREEN}✅ $PROCESSES_KILLED processus tué(s)${NC}"
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}✅ Aucun processus suspect${NC}"
fi

# 2. Vérifier et supprimer les dossiers suspects
echo ""
echo -e "${YELLOW}2️⃣ Dossiers suspects:${NC}"
SUSPECT_DIRS=(
    "$HOME/moneroocean"
    "$HOME/xmrig"
    "$HOME/xmrig-6.21.0"
    "/tmp/moneroocean"
    "/tmp/xmrig"
    "/var/tmp/moneroocean"
    "/var/tmp/xmrig"
)

for dir in "${SUSPECT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "   ${RED}⚠️  THREAT DETECTED: $dir existe !${NC}"
        log "ALERTE: Dossier suspect détecté: $dir"
        rm -rf "$dir" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé${NC}" && log "Dossier supprimé: $dir" && FILES_REMOVED=$((FILES_REMOVED + 1)) || sudo rm -rf "$dir" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé (sudo)${NC}" && log "Dossier supprimé (sudo): $dir" && FILES_REMOVED=$((FILES_REMOVED + 1))
        THREAT_DETECTED=1
    fi
done

# Supprimer les fichiers malveillants connus
MALWARE_FILES=(
    "$HOME/xmrig.tar.gz"
    "$HOME/monitor.log"
    "$HOME/exploited.log"
    "$HOME/failed.log"
    "$HOME/scanner_deployed.log"
    "$HOME/scanner_linux"
    "$HOME/systemwatcher"
    "/tmp/scanner_linux"
    "/tmp/systemwatcher"
    "/var/tmp/scanner_linux"
    "/var/tmp/systemwatcher"
)

CURRENT_DIR=$(pwd)
for file in "${MALWARE_FILES[@]}" "$CURRENT_DIR/xmrig.tar.gz" "$CURRENT_DIR/xmrig-6.21.0" "$CURRENT_DIR/monitor.log" "$CURRENT_DIR/exploited.log" "$CURRENT_DIR/failed.log" "$CURRENT_DIR/scanner_deployed.log"; do
    if [ -f "$file" ] || [ -d "$file" ]; then
        echo -e "   ${RED}⚠️  Fichier malveillant trouvé: $file${NC}"
        log "ALERTE: Fichier malveillant détecté: $file"
        if [ -d "$file" ]; then
            rm -rf "$file" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé${NC}" && log "Fichier supprimé: $file" && FILES_REMOVED=$((FILES_REMOVED + 1)) || sudo rm -rf "$file" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé (sudo)${NC}" && log "Fichier supprimé (sudo): $file" && FILES_REMOVED=$((FILES_REMOVED + 1))
        else
            rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé${NC}" && log "Fichier supprimé: $file" && FILES_REMOVED=$((FILES_REMOVED + 1)) || sudo rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}✅ Supprimé (sudo)${NC}" && log "Fichier supprimé (sudo): $file" && FILES_REMOVED=$((FILES_REMOVED + 1))
        fi
        THREAT_DETECTED=1
    fi
done

if [ $THREAT_DETECTED -eq 0 ]; then
    echo -e "   ${GREEN}✅ Aucun dossier/fichier suspect${NC}"
fi

# 3. Vérifier et nettoyer les crontabs
echo ""
echo -e "${YELLOW}3️⃣ Crontabs suspects:${NC}"
CRON_SUSPECT=$(crontab -l 2>/dev/null | grep -E "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|178\.16\.52\.253|1utig|tli\.sh)" || true)
if [ -n "$CRON_SUSPECT" ]; then
    echo -e "   ${RED}⚠️  THREAT DETECTED dans crontab !${NC}"
    echo "$CRON_SUSPECT" | sed 's/^/      /'
    log "ALERTE: Crontab suspect détecté"
    # Nettoyer automatiquement
    crontab -l 2>/dev/null | grep -vE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|178\.16\.52\.253|1utig|tli\.sh)" | crontab - 2>/dev/null
    echo -e "   ${GREEN}✅ Crontab nettoyé${NC}"
    log "Crontab nettoyé automatiquement"
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}✅ Crontab propre${NC}"
fi

# 4. Vérifier la mémoire
echo ""
echo -e "${YELLOW}4️⃣ Utilisation de la mémoire:${NC}"
MEM_INFO=$(free -h | grep Mem)
MEM_USED=$(echo $MEM_INFO | awk '{print $3}')
MEM_TOTAL=$(echo $MEM_INFO | awk '{print $2}')
MEM_PERCENT=$(free | grep Mem | awk '{printf "%.0f", ($3/$2) * 100}')

if [ "$MEM_PERCENT" -gt 90 ]; then
    echo -e "   ${RED}⚠️  Mémoire très utilisée: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
    THREAT_DETECTED=1
elif [ "$MEM_PERCENT" -gt 80 ]; then
    echo -e "   ${YELLOW}⚠️  Mémoire élevée: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
else
    echo -e "   ${GREEN}✅ Mémoire OK: ${MEM_PERCENT}%${NC}"
    echo "   $MEM_INFO"
fi

# 5. Vérifier les services systemd
echo ""
echo -e "${YELLOW}5️⃣ Services systemd suspects:${NC}"
SERVICES=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" || true)
if [ -n "$SERVICES" ]; then
    echo -e "   ${RED}⚠️  THREAT DETECTED !${NC}"
    echo "$SERVICES" | sed 's/^/      /'
    THREAT_DETECTED=1
else
    echo -e "   ${GREEN}✅ Aucun service suspect${NC}"
fi

# Résumé
echo ""
echo "====================================="
if [ $THREAT_DETECTED -eq 1 ]; then
    echo -e "${RED}⚠️  MENACE DÉTECTÉE ET NETTOYÉE !${NC}"
    echo ""
    echo "   - $PROCESSES_KILLED processus tué(s)"
    echo "   - $FILES_REMOVED fichier(s)/dossier(s) supprimé(s)"
    log "MENACE DÉTECTÉE ET NETTOYÉE: $PROCESSES_KILLED processus, $FILES_REMOVED fichiers"
    exit 1
else
    echo -e "${GREEN}✅ Aucune menace détectée${NC}"
    exit 0
fi
