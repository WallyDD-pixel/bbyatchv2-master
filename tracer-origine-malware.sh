#!/bin/bash

echo "ğŸ” TRACE DE L'ORIGINE DU MALWARE"
echo "================================="
echo ""

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 1. Informations sur les fichiers suspects
echo -e "${BLUE}1ï¸âƒ£ ANALYSE DES FICHIERS SUSPECTS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -d "xmrig-6.21.0" ]; then
    echo -e "${RED}ğŸ“ Dossier xmrig-6.21.0 trouvÃ©${NC}"
    echo "   Date de crÃ©ation/modification:"
    stat -c "   CrÃ©Ã©: %w | ModifiÃ©: %y" xmrig-6.21.0 2>/dev/null || ls -ld xmrig-6.21.0
    echo "   Taille:"
    du -sh xmrig-6.21.0 2>/dev/null
    echo "   Contenu:"
    ls -lah xmrig-6.21.0/ | head -20
    echo ""
fi

if [ -f "xmrig.tar.gz" ]; then
    echo -e "${RED}ğŸ“¦ Fichier xmrig.tar.gz trouvÃ©${NC}"
    echo "   Date de crÃ©ation/modification:"
    stat -c "   CrÃ©Ã©: %w | ModifiÃ©: %y" xmrig.tar.gz 2>/dev/null || ls -l xmrig.tar.gz
    echo "   Taille: $(du -h xmrig.tar.gz | cut -f1)"
    echo "   Type de fichier:"
    file xmrig.tar.gz
    echo ""
fi

# 2. Processus en cours
echo -e "${BLUE}2ï¸âƒ£ PROCESSUS MALVEILLANTS ACTIFS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
PROCESSES=$(ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep)
if [ -n "$PROCESSES" ]; then
    echo -e "${RED}âš ï¸  Processus dÃ©tectÃ©s:${NC}"
    echo "$PROCESSES"
    echo ""
    echo "   DÃ©tails des processus:"
    ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep | while read line; do
        PID=$(echo $line | awk '{print $2}')
        echo "   PID $PID:"
        echo "     Commande complÃ¨te: $(ps -p $PID -o cmd= 2>/dev/null)"
        echo "     RÃ©pertoire de travail: $(pwdx $PID 2>/dev/null || readlink /proc/$PID/cwd 2>/dev/null || echo 'N/A')"
        echo "     Fichiers ouverts:"
        lsof -p $PID 2>/dev/null | head -5 | tail -4 | sed 's/^/       /'
        echo ""
    done
else
    echo -e "${GREEN}âœ… Aucun processus actif${NC}"
    echo ""
fi

# 3. Historique des commandes
echo -e "${BLUE}3ï¸âƒ£ HISTORIQUE DES COMMANDES (bash_history)${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -f ~/.bash_history ]; then
    echo "   DerniÃ¨res commandes suspectes:"
    grep -E "(xmrig|moneroocean|miner|wget.*178\.16\.52\.253|curl.*178\.16\.52\.253|1utig)" ~/.bash_history | tail -20 | sed 's/^/   /'
    echo ""
    echo "   DerniÃ¨res commandes wget/curl:"
    grep -E "(wget|curl).*http" ~/.bash_history | tail -10 | sed 's/^/   /'
    echo ""
else
    echo "   Fichier .bash_history non trouvÃ©"
    echo ""
fi

# 4. Crontabs
echo -e "${BLUE}4ï¸âƒ£ CRONTABS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   Crontab utilisateur:"
if crontab -l 2>/dev/null | grep -qE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh)"; then
    echo -e "${RED}âš ï¸  EntrÃ©es suspectes trouvÃ©es:${NC}"
    crontab -l 2>/dev/null | grep -E "(xmrig|moneroocean|miner|wget.*sh|curl.*sh)" | sed 's/^/   /'
else
    echo -e "${GREEN}   âœ… Crontab utilisateur propre${NC}"
fi
echo ""

echo "   Crontab systÃ¨me (/etc/crontab):"
if sudo grep -qE "(xmrig|moneroocean|miner)" /etc/crontab 2>/dev/null; then
    echo -e "${RED}âš ï¸  EntrÃ©es suspectes trouvÃ©es:${NC}"
    sudo grep -E "(xmrig|moneroocean|miner)" /etc/crontab | sed 's/^/   /'
else
    echo -e "${GREEN}   âœ… Crontab systÃ¨me propre${NC}"
fi
echo ""

echo "   Crontabs dans /etc/cron.d:"
if [ -d /etc/cron.d ]; then
    for cron_file in /etc/cron.d/*; do
        if [ -f "$cron_file" ] && sudo grep -qE "(xmrig|moneroocean|miner)" "$cron_file" 2>/dev/null; then
            echo -e "${RED}âš ï¸  Fichier suspect: $cron_file${NC}"
            sudo grep -E "(xmrig|moneroocean|miner)" "$cron_file" | sed 's/^/   /'
        fi
    done
fi
echo ""

# 5. Services systemd
echo -e "${BLUE}5ï¸âƒ£ SERVICES SYSTEMD${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
SERVICES=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" || true)
if [ -n "$SERVICES" ]; then
    echo -e "${RED}âš ï¸  Services suspects trouvÃ©s:${NC}"
    echo "$SERVICES" | sed 's/^/   /'
    echo ""
    echo "   DÃ©tails des services:"
    systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" | awk '{print $1}' | while read service; do
        echo "   Service: $service"
        sudo systemctl status "$service" 2>/dev/null | head -10 | sed 's/^/     /'
        echo ""
    done
else
    echo -e "${GREEN}âœ… Aucun service suspect${NC}"
    echo ""
fi

# 6. Fichiers de dÃ©marrage
echo -e "${BLUE}6ï¸âƒ£ FICHIERS DE DÃ‰MARRAGE${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
STARTUP_FILES=(
    "$HOME/.bashrc"
    "$HOME/.bash_profile"
    "$HOME/.profile"
    "/etc/profile"
    "/etc/rc.local"
)

for file in "${STARTUP_FILES[@]}"; do
    if [ -f "$file" ]; then
        if grep -qE "(xmrig|moneroocean|miner|wget.*178\.16\.52\.253|curl.*178\.16\.52\.253)" "$file" 2>/dev/null; then
            echo -e "${RED}âš ï¸  Contenu suspect dans: $file${NC}"
            grep -E "(xmrig|moneroocean|miner|wget.*178\.16\.52\.253|curl.*178\.16\.52\.253)" "$file" | sed 's/^/   /'
            echo ""
        fi
    fi
done

# 7. Packages npm rÃ©cemment installÃ©s
echo -e "${BLUE}7ï¸âƒ£ PACKAGES NPM RÃ‰CEMMENT INSTALLÃ‰S${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -f "package-lock.json" ]; then
    echo "   Recherche de packages suspects dans package-lock.json..."
    if grep -qiE "(xmrig|moneroocean|miner)" package-lock.json 2>/dev/null; then
        echo -e "${RED}âš ï¸  Packages suspects trouvÃ©s:${NC}"
        grep -iE "(xmrig|moneroocean|miner)" package-lock.json | head -10 | sed 's/^/   /'
    else
        echo -e "${GREEN}   âœ… Aucun package suspect dans package-lock.json${NC}"
    fi
    echo ""
    
    echo "   VÃ©rification des scripts postinstall:"
    find node_modules -name "package.json" -exec grep -l "postinstall" {} \; 2>/dev/null | while read pkg; do
        if grep -qiE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|178\.16\.52\.253)" "$pkg" 2>/dev/null; then
            echo -e "${RED}âš ï¸  Package suspect: $pkg${NC}"
            grep -iE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|178\.16\.52\.253)" "$pkg" | sed 's/^/     /'
        fi
    done
    echo ""
fi

# 8. Logs systÃ¨me
echo -e "${BLUE}8ï¸âƒ£ LOGS SYSTÃˆME${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   DerniÃ¨res connexions SSH:"
sudo lastlog | tail -10 | sed 's/^/   /'
echo ""

echo "   DerniÃ¨res authentifications SSH (derniÃ¨res 50 lignes):"
if [ -f /var/log/auth.log ]; then
    sudo tail -50 /var/log/auth.log | grep -E "(Accepted|Failed|Invalid)" | tail -20 | sed 's/^/   /'
elif [ -f /var/log/secure ]; then
    sudo tail -50 /var/log/secure | grep -E "(Accepted|Failed|Invalid)" | tail -20 | sed 's/^/   /'
else
    echo "   Fichier de log d'authentification non trouvÃ©"
fi
echo ""

echo "   Recherche de xmrig dans les logs systÃ¨me:"
if [ -f /var/log/syslog ]; then
    sudo grep -i "xmrig\|moneroocean\|miner" /var/log/syslog | tail -10 | sed 's/^/   /'
elif [ -f /var/log/messages ]; then
    sudo grep -i "xmrig\|moneroocean\|miner" /var/log/messages | tail -10 | sed 's/^/   /'
fi
echo ""

# 9. Connexions rÃ©seau
echo -e "${BLUE}9ï¸âƒ£ CONNEXIONS RÃ‰SEAU${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   Connexions Ã©tablies:"
netstat -tulpn 2>/dev/null | grep -E "(ESTABLISHED|LISTEN)" | grep -E "(xmrig|178\.16\.52\.253|3\.27\.49\.205)" | sed 's/^/   /' || echo "   Aucune connexion suspecte dÃ©tectÃ©e"
echo ""

# 10. Fichiers rÃ©cemment modifiÃ©s
echo -e "${BLUE}ğŸ”Ÿ FICHIERS RÃ‰CEMMENT MODIFIÃ‰S${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   Fichiers modifiÃ©s dans les 7 derniers jours contenant 'xmrig':"
find ~ -type f -mtime -7 -name "*xmrig*" 2>/dev/null | head -20 | while read file; do
    echo "   $file"
    stat -c "     ModifiÃ©: %y" "$file" 2>/dev/null || ls -l "$file" | awk '{print "     "$6" "$7" "$8}'
done
echo ""

# 11. ClÃ©s SSH autorisÃ©es
echo -e "${BLUE}1ï¸âƒ£1ï¸âƒ£ CLÃ‰S SSH AUTORISÃ‰ES${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -f ~/.ssh/authorized_keys ]; then
    echo "   Nombre de clÃ©s: $(wc -l < ~/.ssh/authorized_keys)"
    echo "   ClÃ©s:"
    cat ~/.ssh/authorized_keys | while read line; do
        if [ -n "$line" ]; then
            echo "   $(echo $line | cut -d' ' -f3- | head -c 50)..."
        fi
    done
else
    echo "   Fichier authorized_keys non trouvÃ©"
fi
echo ""

# 12. RÃ©sumÃ© et recommandations
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${YELLOW}ğŸ“‹ RÃ‰SUMÃ‰${NC}"
echo ""
echo "   Fichiers suspects trouvÃ©s:"
[ -d "xmrig-6.21.0" ] && echo "   - xmrig-6.21.0/" || echo "   - Aucun"
[ -f "xmrig.tar.gz" ] && echo "   - xmrig.tar.gz" || echo "   - Aucun"
echo ""
echo -e "${YELLOW}ğŸ” PROCHAINES Ã‰TAPES${NC}"
echo "   1. Examiner les dates de crÃ©ation/modification des fichiers"
echo "   2. VÃ©rifier l'historique des commandes pour voir comment ils sont arrivÃ©s"
echo "   3. VÃ©rifier les logs d'authentification SSH pour des accÃ¨s non autorisÃ©s"
echo "   4. VÃ©rifier les packages npm installÃ©s rÃ©cemment"
echo "   5. VÃ©rifier les scripts postinstall des packages npm"
echo ""
echo -e "${YELLOW}âš ï¸  ATTENTION${NC}"
echo "   Ne supprimez PAS les fichiers avant d'avoir terminÃ© l'analyse !"
echo "   Les dates de modification peuvent rÃ©vÃ©ler comment le malware est arrivÃ©."
echo ""
