#!/bin/bash

echo "ğŸ” Recherche du point d'entrÃ©e du malware"
echo "=========================================="
echo ""

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 1. Analyser les logs d'authentification pour trouver les connexions suspectes
echo -e "${BLUE}1ï¸âƒ£ Analyse des connexions SSH rÃ©centes...${NC}"
if [ -f /var/log/auth.log ]; then
    LOG_FILE="/var/log/auth.log"
elif [ -f /var/log/secure ]; then
    LOG_FILE="/var/log/secure"
else
    LOG_FILE=""
fi

if [ -n "$LOG_FILE" ]; then
    echo "   Fichier: $LOG_FILE"
    echo ""
    echo "   ğŸ“Š Statistiques des connexions (derniÃ¨res 100 lignes):"
    sudo tail -100 "$LOG_FILE" | grep -E "Accepted|Failed" | awk '{
        if ($0 ~ /Accepted/) {
            accepted++
            user = $(NF-3)
            ip = $(NF-5)
            print "   âœ… Connexion acceptÃ©e: " user "@" ip
        } else if ($0 ~ /Failed/) {
            failed++
            user = $(NF-5)
            ip = $(NF-3)
            print "   âŒ Ã‰chec: " user "@" ip
        }
    }'
    
    echo ""
    echo "   ğŸ” IPs qui se sont connectÃ©es avec succÃ¨s:"
    sudo grep "Accepted" "$LOG_FILE" | tail -20 | awk '{print $(NF-5)}' | sort | uniq -c | sort -rn | head -10 | sed 's/^/      /'
    
    echo ""
    echo "   ğŸ” IPs avec le plus d'Ã©checs (attaques possibles):"
    sudo grep "Failed password" "$LOG_FILE" | tail -50 | awk '{print $(NF-3)}' | sort | uniq -c | sort -rn | head -10 | sed 's/^/      /'
else
    echo -e "   ${YELLOW}âš ï¸  Fichier de log non trouvÃ©${NC}"
fi
echo ""

# 2. VÃ©rifier quand les fichiers suspects ont Ã©tÃ© crÃ©Ã©s
echo -e "${BLUE}2ï¸âƒ£ Dates de crÃ©ation des fichiers suspects...${NC}"
SUSPECT_LOCATIONS=(
    "$HOME/moneroocean"
    "$HOME/systemwatcher"
    "$HOME/scanner_linux"
    "$HOME/xmrig"
    "/tmp/moneroocean"
    "/tmp/systemwatcher"
)

for location in "${SUSPECT_LOCATIONS[@]}"; do
    if [ -e "$location" ]; then
        if [ -f "$location" ]; then
            CREATED=$(stat -c "%y" "$location" 2>/dev/null || stat -f "%Sm" "$location" 2>/dev/null || echo "unknown")
            echo "   ğŸ“… $location crÃ©Ã© le: $CREATED"
        elif [ -d "$location" ]; then
            CREATED=$(stat -c "%y" "$location" 2>/dev/null || stat -f "%Sm" "$location" 2>/dev/null || echo "unknown")
            echo "   ğŸ“… $location crÃ©Ã© le: $CREATED"
        fi
    fi
done
echo ""

# 3. VÃ©rifier les scripts de tÃ©lÃ©chargement dans les crontabs
echo -e "${BLUE}3ï¸âƒ£ Recherche de scripts de tÃ©lÃ©chargement automatique...${NC}"
ALL_CRONS=$(crontab -l 2>/dev/null; sudo cat /etc/crontab 2>/dev/null; sudo cat /etc/cron.d/* 2>/dev/null 2>/dev/null || true)

DOWNLOAD_SCRIPTS=$(echo "$ALL_CRONS" | grep -E "(wget|curl).*http" || true)
if [ -n "$DOWNLOAD_SCRIPTS" ]; then
    echo -e "   ${RED}âš ï¸  Scripts de tÃ©lÃ©chargement trouvÃ©s:${NC}"
    echo "$DOWNLOAD_SCRIPTS" | sed 's/^/      /'
    echo ""
    echo "   ğŸ” URLs suspectes:"
    echo "$DOWNLOAD_SCRIPTS" | grep -oE "https?://[^ ]+" | sed 's/^/      /'
else
    echo -e "   ${GREEN}âœ… Aucun script de tÃ©lÃ©chargement trouvÃ©${NC}"
fi
echo ""

# 4. VÃ©rifier les processus qui se relancent automatiquement
echo -e "${BLUE}4ï¸âƒ£ Recherche de mÃ©canismes de persistance...${NC}"

# VÃ©rifier systemd
PERSISTENT_SERVICES=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(systemwatcher|scanner|xmrig|moneroocean|miner)" || true)
if [ -n "$PERSISTENT_SERVICES" ]; then
    echo -e "   ${RED}âš ï¸  Services systemd suspects (persistance):${NC}"
    echo "$PERSISTENT_SERVICES" | sed 's/^/      /'
    echo ""
    echo "   Fichiers de service:"
    for service in $(echo "$PERSISTENT_SERVICES" | awk '{print $1}'); do
        SERVICE_FILE=$(systemctl show "$service" -p FragmentPath 2>/dev/null | cut -d= -f2)
        if [ -n "$SERVICE_FILE" ] && [ -f "$SERVICE_FILE" ]; then
            echo "      $SERVICE_FILE"
            sudo cat "$SERVICE_FILE" | grep -E "ExecStart|ExecStartPre" | sed 's/^/         /'
        fi
    done
fi

# VÃ©rifier les scripts de dÃ©marrage
STARTUP_SCRIPTS=$(grep -rE "(systemwatcher|scanner_linux|xmrig|moneroocean)" ~/.bashrc ~/.bash_profile ~/.profile /etc/rc.local /etc/profile 2>/dev/null || true)
if [ -n "$STARTUP_SCRIPTS" ]; then
    echo -e "   ${RED}âš ï¸  Scripts de dÃ©marrage suspects:${NC}"
    echo "$STARTUP_SCRIPTS" | sed 's/^/      /'
fi
echo ""

# 5. VÃ©rifier les fichiers rÃ©cemment modifiÃ©s
echo -e "${BLUE}5ï¸âƒ£ Fichiers rÃ©cemment modifiÃ©s dans le home (suspects)...${NC}"
RECENT_FILES=$(find ~ -maxdepth 2 -type f -mtime -7 2>/dev/null | grep -E "(\.sh$|systemwatcher|scanner|xmrig|moneroocean)" || true)
if [ -n "$RECENT_FILES" ]; then
    echo "   Fichiers modifiÃ©s rÃ©cemment:"
    for file in $RECENT_FILES; do
        MOD_TIME=$(stat -c "%y" "$file" 2>/dev/null || stat -f "%Sm" "$file" 2>/dev/null || echo "unknown")
        echo "      $file (modifiÃ©: $MOD_TIME)"
    done
else
    echo -e "   ${GREEN}âœ… Aucun fichier suspect rÃ©cemment modifiÃ©${NC}"
fi
echo ""

# 6. RÃ©sumÃ© et recommandations
echo "=========================================="
echo -e "${YELLOW}ğŸ“‹ Comment le malware peut revenir:${NC}"
echo ""
echo "   1. ğŸ”‘ ClÃ© SSH compromise dans ~/.ssh/authorized_keys"
echo "   2. ğŸ“ Crontab qui tÃ©lÃ©charge et exÃ©cute le malware"
echo "   3. ğŸ”„ Service systemd qui se relance automatiquement"
echo "   4. ğŸš€ Script dans .bashrc/.profile qui s'exÃ©cute au login"
echo "   5. ğŸŒ Faille dans une application web (Next.js, API, etc.)"
echo "   6. ğŸ” Mot de passe faible ou compromis"
echo ""
echo -e "${BLUE}ğŸ›¡ï¸  Actions pour empÃªcher le retour:${NC}"
echo ""
echo "   1. VÃ©rifiez ~/.ssh/authorized_keys et supprimez les clÃ©s inconnues"
echo "   2. ExÃ©cutez: bash audit-security.sh pour un audit complet"
echo "   3. Changez tous les mots de passe"
echo "   4. Limitez l'accÃ¨s SSH aux Security Groups AWS"
echo "   5. Surveillez les logs: sudo tail -f /var/log/auth.log"
echo "   6. VÃ©rifiez votre application web pour les failles"
echo ""
