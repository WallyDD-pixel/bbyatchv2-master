# ðŸš¨ URGENCE - MALWARE DÃ‰TECTÃ‰

## âš ï¸ SITUATION CRITIQUE

Un malware a Ã©tÃ© dÃ©tectÃ© dans les logs PM2. Il tente de :
- Se connecter Ã  un serveur externe malveillant (`abcdefghijklmnopqrst.net`)
- TÃ©lÃ©charger et exÃ©cuter des scripts
- Se propager dans le systÃ¨me
- Se cacher dans `/tmp`, `$HOME`, etc.

## ðŸ›‘ ACTIONS IMMÃ‰DIATES (Ã€ EXÃ‰CUTER MAINTENANT)

### 1. ArrÃªter PM2 immÃ©diatement

```bash
pm2 stop bbyatch
pm2 delete bbyatch
```

### 2. Nettoyer les fichiers suspects

```bash
# Chercher et supprimer les fichiers suspects
find /tmp -name "s" -type f -delete 2>/dev/null
find $HOME -name "s" -type f -delete 2>/dev/null
find /var/tmp -name "s" -type f -delete 2>/dev/null

# Chercher les processus suspects
ps aux | grep -E "nc|wget|curl|python3|perl" | grep -v grep

# Tuer les processus suspects (remplacer PID par le numÃ©ro trouvÃ©)
# kill -9 PID
```

### 3. VÃ©rifier les packages npm compromis

```bash
# VÃ©rifier les packages installÃ©s rÃ©cemment
npm list --depth=0 | grep -E "suspicious|unknown"

# VÃ©rifier les scripts dans package.json
cat package.json | grep -A 5 "scripts"

# VÃ©rifier les hooks npm
ls -la node_modules/.hooks/ 2>/dev/null
```

### 4. VÃ©rifier les processus en cours

```bash
# Lister tous les processus Node
ps aux | grep node | grep -v grep

# VÃ©rifier les connexions rÃ©seau suspectes
netstat -tulpn | grep -E "abcdefghijklmnopqrst|nc|wget"

# VÃ©rifier les fichiers ouverts par les processus Node
lsof -p $(pgrep -f "next start") 2>/dev/null | head -20
```

### 5. Nettoyer node_modules et rÃ©installer

```bash
# Sauvegarder package-lock.json
cp package-lock.json package-lock.json.backup

# Supprimer node_modules
rm -rf node_modules

# VÃ©rifier package-lock.json pour des URLs suspectes
grep -i "abcdefghijklmnopqrst\|http://\|https://" package-lock.json | head -20

# RÃ©installer proprement
npm ci --no-audit
```

### 6. VÃ©rifier les fichiers systÃ¨me

```bash
# VÃ©rifier les crontabs
crontab -l
sudo crontab -l

# VÃ©rifier les services systemd
systemctl list-units --type=service | grep -i node

# VÃ©rifier les fichiers de dÃ©marrage
ls -la ~/.bashrc ~/.bash_profile ~/.profile
```

## ðŸ” DIAGNOSTIC DE L'ERREUR TECHNIQUE

L'erreur `TypeError: controller[kState].transformAlgorithm is not a function` peut Ãªtre causÃ©e par :
- Une version incompatible de Node.js
- Un package npm corrompu
- Un conflit de dÃ©pendances

### VÃ©rifier la version de Node.js

```bash
node --version
# Devrait Ãªtre Node.js 20.x LTS
```

### VÃ©rifier les dÃ©pendances

```bash
npm outdated
npm audit
```

## ðŸ”§ CORRECTION APRÃˆS NETTOYAGE

### 1. Rebuild propre

```bash
# Nettoyer le build
rm -rf .next

# Rebuild
npm run build
```

### 2. RedÃ©marrer PM2 proprement

```bash
# VÃ©rifier que tout est propre
pm2 list
# Devrait Ãªtre vide

# RedÃ©marrer
pm2 start ecosystem.config.cjs
pm2 save
```

## ðŸ“‹ CHECKLIST POST-NETTOYAGE

- [ ] PM2 arrÃªtÃ© et supprimÃ©
- [ ] Fichiers suspects supprimÃ©s
- [ ] Processus malveillants tuÃ©s
- [ ] node_modules nettoyÃ© et rÃ©installÃ©
- [ ] package-lock.json vÃ©rifiÃ©
- [ ] Crontabs vÃ©rifiÃ©s
- [ ] Build propre effectuÃ©
- [ ] PM2 redÃ©marrÃ©
- [ ] Logs vÃ©rifiÃ©s (plus d'erreurs malware)
- [ ] Site fonctionnel

## ðŸš¨ SI LE MALWARE PERSISTE

1. **ArrÃªter complÃ¨tement le serveur** :
   ```bash
   sudo systemctl stop nginx
   pm2 stop all
   ```

2. **Isoler le serveur** (fermer les ports non essentiels)

3. **Scanner avec des outils antivirus** :
   ```bash
   # Installer ClamAV si disponible
   sudo yum install clamav -y
   sudo freshclam
   sudo clamscan -r /home/ec2-user/bbyatchv2-master/
   ```

4. **Contacter le support AWS** si nÃ©cessaire

## ðŸ“ž PROCHAINES Ã‰TAPES

AprÃ¨s le nettoyage, exÃ©cutez ces commandes dans l'ordre et partagez les rÃ©sultats :

```bash
# 1. ArrÃªter PM2
pm2 stop all && pm2 delete all

# 2. Nettoyer les fichiers
find /tmp $HOME -name "s" -type f -delete 2>/dev/null

# 3. VÃ©rifier les processus
ps aux | grep -E "nc|wget|curl|python3" | grep -v grep

# 4. VÃ©rifier node_modules
ls -la node_modules/.hooks/ 2>/dev/null

# 5. VÃ©rifier package-lock.json
grep -i "http://\|https://" package-lock.json | head -10
```
