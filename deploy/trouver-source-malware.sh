#!/bin/bash
# Script pour trouver pourquoi le malware Monero revient constamment

echo "=== RECHERCHE DE LA SOURCE DU MALWARE ==="
echo ""

# 1. Vérifier les processus actifs
echo "1. Processus xmrig/monero actifs:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "Aucun processus actif"
echo ""

# 2. Vérifier les crontabs (tous les utilisateurs)
echo "2. Crontabs (tous utilisateurs):"
echo "--- Crontab root:"
sudo crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "Rien trouvé"
echo "--- Crontab $USER:"
crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "Rien trouvé"
echo "--- Crontabs système:"
sudo ls -la /var/spool/cron/crontabs/ 2>/dev/null | head -10
for user in $(cut -f1 -d: /etc/passwd); do
    sudo crontab -u "$user" -l 2>/dev/null | grep -E "xmrig|monero" && echo "⚠️ Trouvé dans crontab de $user"
done
echo ""

# 3. Vérifier les services systemd
echo "3. Services systemd:"
sudo systemctl list-units --all | grep -E "monero|xmrig" || echo "Aucun service trouvé"
sudo ls -la /etc/systemd/system/*.service 2>/dev/null | grep -E "monero|xmrig" || echo "Aucun fichier service"
echo ""

# 4. Vérifier les scripts de démarrage
echo "4. Scripts de démarrage:"
echo "--- /etc/rc.local:"
sudo cat /etc/rc.local 2>/dev/null | grep -E "xmrig|monero" || echo "Rien"
echo "--- /etc/rc.d/rc.local:"
sudo cat /etc/rc.d/rc.local 2>/dev/null | grep -E "xmrig|monero" || echo "Rien"
echo "--- /etc/init.d:"
sudo ls -la /etc/init.d/ 2>/dev/null | grep -E "monero|xmrig" || echo "Rien"
echo ""

# 5. Vérifier les fichiers .bashrc, .profile, .bash_profile
echo "5. Fichiers de profil shell:"
for file in ~/.bashrc ~/.profile ~/.bash_profile /root/.bashrc /root/.profile /root/.bash_profile; do
    if [ -f "$file" ]; then
        if grep -qE "xmrig|monero" "$file" 2>/dev/null; then
            echo "⚠️ Trouvé dans $file:"
            grep -E "xmrig|monero" "$file"
        fi
    fi
done
echo ""

# 6. Vérifier les scripts dans /etc/profile.d
echo "6. Scripts /etc/profile.d:"
sudo ls -la /etc/profile.d/ 2>/dev/null
for script in /etc/profile.d/*.sh; do
    if [ -f "$script" ]; then
        if grep -qE "xmrig|monero" "$script" 2>/dev/null; then
            echo "⚠️ Trouvé dans $script"
        fi
    fi
done
echo ""

# 7. Vérifier les tâches systemd timer
echo "7. Timers systemd:"
sudo systemctl list-timers --all | grep -E "monero|xmrig" || echo "Aucun timer"
sudo ls -la /etc/systemd/system/*.timer 2>/dev/null | grep -E "monero|xmrig" || echo "Rien"
echo ""

# 8. Vérifier les fichiers dans moneroocean
echo "8. Contenu du répertoire moneroocean:"
if [ -d ~/moneroocean ]; then
    ls -la ~/moneroocean/
    echo "--- Fichiers .sh:"
    find ~/moneroocean -name "*.sh" 2>/dev/null
    echo "--- Contenu de miner.sh (si existe):"
    cat ~/moneroocean/miner.sh 2>/dev/null | head -20 || echo "Fichier non trouvé"
fi
echo ""

# 9. Vérifier les connexions réseau suspectes
echo "9. Connexions réseau suspectes:"
ss -tunp | grep -E "xmrig|monero" || netstat -tunp 2>/dev/null | grep -E "xmrig|monero" || echo "Aucune connexion"
echo ""

# 10. Vérifier les fichiers récemment modifiés
echo "10. Fichiers récemment modifiés dans moneroocean:"
find ~/moneroocean -type f -mtime -1 2>/dev/null | head -10 || echo "Aucun fichier récent"
echo ""

# 11. Vérifier les processus parents suspects
echo "11. Arborescence des processus:"
if pgrep -f xmrig > /dev/null; then
    XMRIG_PID=$(pgrep -f xmrig | head -1)
    echo "PID xmrig: $XMRIG_PID"
    ps -ef | grep -E "$XMRIG_PID|PPID" | head -5
    pstree -p $XMRIG_PID 2>/dev/null || ps -o ppid= -p $XMRIG_PID | xargs ps -p 2>/dev/null
fi
echo ""

# 12. Vérifier les scripts qui téléchargent/installent
echo "12. Recherche de scripts d'installation:"
find /tmp /var/tmp ~ -name "*.sh" -type f -mtime -7 2>/dev/null | xargs grep -l "xmrig\|monero" 2>/dev/null | head -10 || echo "Aucun script trouvé"
echo ""

# 13. Vérifier les clés SSH autorisées (backdoor possible)
echo "13. Clés SSH autorisées:"
echo "--- ~/.ssh/authorized_keys:"
cat ~/.ssh/authorized_keys 2>/dev/null | wc -l
sudo cat /root/.ssh/authorized_keys 2>/dev/null | wc -l
echo ""

# 14. Vérifier les logs système récents
echo "14. Logs système (dernières lignes avec xmrig/monero):"
sudo journalctl -xe --since "1 hour ago" 2>/dev/null | grep -iE "xmrig|monero" | tail -10 || echo "Rien dans les logs récents"
echo ""

# 15. Vérifier les fichiers avec setuid/setgid suspects
echo "15. Fichiers avec permissions suspectes:"
find ~/moneroocean -perm -4000 -o -perm -2000 2>/dev/null || echo "Aucun"
echo ""

echo "=== FIN DE LA RECHERCHE ==="
echo ""
echo "Points à vérifier manuellement:"
echo "1. Les crontabs (surtout root)"
echo "2. Les services systemd"
echo "3. Les scripts de démarrage"
echo "4. Le contenu de ~/moneroocean/miner.sh"
echo "5. Les processus parents de xmrig"
