#!/bin/bash

# Script de diagnostic complet pour identifier la source du malware
# Usage: sudo bash deploy/diagnostic-malware-complet.sh

LOG_FILE="/tmp/malware-diagnostic-$(date +%Y%m%d-%H%M%S).log"
echo "=== DIAGNOSTIC MALWARE COMPLET ===" | tee -a "$LOG_FILE"
echo "Date: $(date)" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_section() {
    echo "" | tee -a "$LOG_FILE"
    echo "========================================" | tee -a "$LOG_FILE"
    echo "  $1" | tee -a "$LOG_FILE"
    echo "========================================" | tee -a "$LOG_FILE"
}

print_alert() {
    echo -e "${RED}⚠️  ALERTE: $1${NC}" | tee -a "$LOG_FILE"
}

print_info() {
    echo -e "${GREEN}ℹ️  $1${NC}" | tee -a "$LOG_FILE"
}

# 1. Vérifier les processus suspects
print_section "1. PROCESSUS SUSPECTS"
SUSPICIOUS_PROCESSES=$(ps aux | grep -E "xmrig|moneroocean|minerd|178.16.52.253|1utig" | grep -v grep)
if [ ! -z "$SUSPICIOUS_PROCESSES" ]; then
    print_alert "Processus malveillants détectés!"
    echo "$SUSPICIOUS_PROCESSES" | tee -a "$LOG_FILE"
else
    print_info "Aucun processus suspect trouvé"
fi

# 2. Vérifier les packages npm avec postinstall
print_section "2. PACKAGES NPM AVEC POSTINSTALL"
POSTINSTALL_PACKAGES=$(find ~/bbyatchv2-master/node_modules -name "package.json" -exec grep -l "postinstall" {} \; 2>/dev/null)
if [ ! -z "$POSTINSTALL_PACKAGES" ]; then
    echo "Packages avec postinstall trouvés:" | tee -a "$LOG_FILE"
    echo "$POSTINSTALL_PACKAGES" | while read pkg; do
        echo "--- $pkg ---" | tee -a "$LOG_FILE"
        grep -A 10 "postinstall" "$pkg" | tee -a "$LOG_FILE"
        # Vérifier si le script contient des commandes suspectes
        if grep -E "wget|curl.*http|sh.*http|178.16.52.253|1utig" "$pkg" >/dev/null 2>&1; then
            print_alert "Script postinstall suspect dans $pkg!"
            grep -E "wget|curl.*http|sh.*http|178.16.52.253|1utig" "$pkg" | tee -a "$LOG_FILE"
        fi
    done
else
    print_info "Aucun package avec postinstall trouvé"
fi

# 3. Vérifier les crontabs
print_section "3. CRONTABS"
echo "Crontab utilisateur:" | tee -a "$LOG_FILE"
crontab -l 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucun crontab utilisateur" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Crontab root:" | tee -a "$LOG_FILE"
sudo crontab -l 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucun crontab root" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Crontabs système:" | tee -a "$LOG_FILE"
sudo ls -la /etc/cron.* 2>/dev/null | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Contenu /etc/crontab:" | tee -a "$LOG_FILE"
sudo cat /etc/crontab 2>/dev/null | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Contenu /etc/cron.d/:" | tee -a "$LOG_FILE"
sudo ls -la /etc/cron.d/ 2>/dev/null | tee -a "$LOG_FILE"
for file in /etc/cron.d/*; do
    if [ -f "$file" ]; then
        echo "--- $file ---" | tee -a "$LOG_FILE"
        sudo cat "$file" 2>/dev/null | tee -a "$LOG_FILE"
    fi
done

# 4. Vérifier les services systemd
print_section "4. SERVICES SYSTEMD"
SUSPICIOUS_SERVICES=$(systemctl list-units --type=service --all | grep -E "xmrig|moneroocean|minerd" || true)
if [ ! -z "$SUSPICIOUS_SERVICES" ]; then
    print_alert "Services suspects trouvés!"
    echo "$SUSPICIOUS_SERVICES" | tee -a "$LOG_FILE"
else
    print_info "Aucun service suspect trouvé"
fi

# 5. Vérifier les fichiers de démarrage
print_section "5. FICHIERS DE DÉMARRAGE"
echo "~/.bashrc:" | tee -a "$LOG_FILE"
cat ~/.bashrc 2>/dev/null | grep -E "wget|curl.*http|sh.*http|178.16.52.253|1utig" | tee -a "$LOG_FILE" || echo "Aucune commande suspecte" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "~/.bash_profile:" | tee -a "$LOG_FILE"
cat ~/.bash_profile 2>/dev/null | grep -E "wget|curl.*http|sh.*http|178.16.52.253|1utig" | tee -a "$LOG_FILE" || echo "Aucune commande suspecte" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "~/.profile:" | tee -a "$LOG_FILE"
cat ~/.profile 2>/dev/null | grep -E "wget|curl.*http|sh.*http|178.16.52.253|1utig" | tee -a "$LOG_FILE" || echo "Aucune commande suspecte" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "/etc/rc.local:" | tee -a "$LOG_FILE"
sudo cat /etc/rc.local 2>/dev/null | tee -a "$LOG_FILE" || echo "Fichier non trouvé" | tee -a "$LOG_FILE"

# 6. Vérifier les fichiers récemment modifiés
print_section "6. FICHIERS RÉCEMMENT MODIFIÉS (24h)"
echo "Fichiers modifiés dans ~/bbyatchv2-master (24h):" | tee -a "$LOG_FILE"
find ~/bbyatchv2-master -type f -mtime -1 -ls 2>/dev/null | head -20 | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Fichiers modifiés dans /tmp (24h):" | tee -a "$LOG_FILE"
find /tmp -type f -mtime -1 -ls 2>/dev/null | head -20 | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Fichiers modifiés dans /var/tmp (24h):" | tee -a "$LOG_FILE"
find /var/tmp -type f -mtime -1 -ls 2>/dev/null | head -20 | tee -a "$LOG_FILE"

# 7. Vérifier les connexions réseau suspectes
print_section "7. CONNEXIONS RÉSEAU"
echo "Connexions établies:" | tee -a "$LOG_FILE"
netstat -tunap 2>/dev/null | grep ESTABLISHED | tee -a "$LOG_FILE" || ss -tunap 2>/dev/null | grep ESTABLISHED | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Connexions vers 178.16.52.253:" | tee -a "$LOG_FILE"
netstat -tunap 2>/dev/null | grep 178.16.52.253 | tee -a "$LOG_FILE" || ss -tunap 2>/dev/null | grep 178.16.52.253 | tee -a "$LOG_FILE" || echo "Aucune connexion vers cette IP" | tee -a "$LOG_FILE"

# 8. Vérifier les logs PM2
print_section "8. LOGS PM2 (DERNIÈRES 50 LIGNES)"
if command -v pm2 &> /dev/null; then
    echo "Logs PM2 (erreurs):" | tee -a "$LOG_FILE"
    pm2 logs --lines 50 --err 2>/dev/null | grep -E "178.16.52.253|1utig|wget|curl.*http|Command failed" | tail -20 | tee -a "$LOG_FILE" || echo "Aucune erreur suspecte dans les logs PM2" | tee -a "$LOG_FILE"
else
    echo "PM2 non installé" | tee -a "$LOG_FILE"
fi

# 9. Vérifier les fichiers suspects dans le projet
print_section "9. FICHIERS SUSPECTS DANS LE PROJET"
echo "Recherche de fichiers contenant l'IP suspecte:" | tee -a "$LOG_FILE"
grep -r "178.16.52.253" ~/bbyatchv2-master 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucun fichier contenant cette IP" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Recherche de fichiers contenant '1utig':" | tee -a "$LOG_FILE"
grep -r "1utig" ~/bbyatchv2-master 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucun fichier contenant '1utig'" | tee -a "$LOG_FILE"

# 10. Vérifier les clés SSH
print_section "10. CLÉS SSH"
echo "Clés SSH autorisées (utilisateur):" | tee -a "$LOG_FILE"
cat ~/.ssh/authorized_keys 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucune clé SSH utilisateur" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Clés SSH autorisées (root):" | tee -a "$LOG_FILE"
sudo cat /root/.ssh/authorized_keys 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucune clé SSH root" | tee -a "$LOG_FILE"

# 11. Vérifier les fichiers exécutables récemment créés
print_section "11. FICHIERS EXÉCUTABLES RÉCEMMENT CRÉÉS"
echo "Fichiers exécutables dans ~/bbyatchv2-master (7 jours):" | tee -a "$LOG_FILE"
find ~/bbyatchv2-master -type f -perm +111 -mtime -7 -ls 2>/dev/null | tee -a "$LOG_FILE" || echo "Aucun fichier exécutable récent" | tee -a "$LOG_FILE"

# 12. Vérifier les variables d'environnement
print_section "12. VARIABLES D'ENVIRONNEMENT SUSPECTES"
env | grep -E "178.16.52.253|1utig|MONERO|XMRIG" | tee -a "$LOG_FILE" || echo "Aucune variable d'environnement suspecte" | tee -a "$LOG_FILE"

# 13. Vérifier les hooks git
print_section "13. HOOKS GIT"
echo "Hooks git dans ~/bbyatchv2-master/.git/hooks:" | tee -a "$LOG_FILE"
ls -la ~/bbyatchv2-master/.git/hooks/ 2>/dev/null | tee -a "$LOG_FILE"
for hook in ~/bbyatchv2-master/.git/hooks/*; do
    if [ -f "$hook" ]; then
        echo "--- Contenu de $hook ---" | tee -a "$LOG_FILE"
        cat "$hook" 2>/dev/null | tee -a "$LOG_FILE"
    fi
done

# 14. Vérifier les logs système
print_section "14. LOGS SYSTÈME (SSH)"
echo "Dernières tentatives SSH (journalctl):" | tee -a "$LOG_FILE"
sudo journalctl -u sshd --since "24 hours ago" --no-pager | tail -30 | tee -a "$LOG_FILE" 2>/dev/null || echo "Impossible d'accéder aux logs SSH" | tee -a "$LOG_FILE"

# Résumé
print_section "RÉSUMÉ"
echo "Le rapport complet a été enregistré dans: $LOG_FILE" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
print_info "Pour examiner le rapport: cat $LOG_FILE"
print_info "Pour rechercher des alertes: grep 'ALERTE' $LOG_FILE"
