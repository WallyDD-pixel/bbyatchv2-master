#!/bin/bash
# Script de diagnostic complet pour trouver la source du malware

echo "üîç === DIAGNOSTIC COMPLET DU MALWARE ==="
echo ""

# 1. Processus actifs
echo "1Ô∏è‚É£ Processus actifs:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "   ‚úÖ Aucun processus actif"
if pgrep -f xmrig > /dev/null; then
    XMRIG_PID=$(pgrep -f xmrig | head -1)
    echo "   PID xmrig: $XMRIG_PID"
    echo "   Processus parent:"
    ps -o ppid= -p $XMRIG_PID | xargs ps -p 2>/dev/null || echo "   Parent non trouv√©"
    echo "   Arborescence:"
    pstree -p $XMRIG_PID 2>/dev/null || ps -ef | grep $XMRIG_PID | head -3
fi
echo ""

# 2. Crontabs d√©taill√©s
echo "2Ô∏è‚É£ Crontabs d√©taill√©s:"
echo "   --- Crontab root (COMPLET):"
sudo crontab -l 2>/dev/null || echo "   Vide"
echo ""
echo "   --- Crontab $USER (COMPLET):"
crontab -l 2>/dev/null || echo "   Vide"
echo ""
echo "   --- /etc/crontab:"
sudo cat /etc/crontab 2>/dev/null | grep -v "^#" | grep -v "^$" || echo "   Vide"
echo ""
echo "   --- Tous les utilisateurs:"
for user in $(cut -f1 -d: /etc/passwd); do
    CRON_CONTENT=$(sudo crontab -u "$user" -l 2>/dev/null)
    if [ -n "$CRON_CONTENT" ]; then
        if echo "$CRON_CONTENT" | grep -qE "curl|wget|http|sh.*http"; then
            echo "   ‚ö†Ô∏è  $user a un crontab avec URL:"
            echo "$CRON_CONTENT" | grep -E "curl|wget|http|sh.*http"
        fi
    fi
done
echo ""

# 3. Services systemd
echo "3Ô∏è‚É£ Services systemd:"
sudo systemctl list-units --all --type=service 2>/dev/null | grep -E "monero|xmrig" || echo "   ‚úÖ Aucun service"
echo ""
echo "   --- Fichiers de service:"
sudo ls -la /etc/systemd/system/*.service 2>/dev/null | grep -E "monero|xmrig" || echo "   ‚úÖ Aucun fichier"
echo ""

# 4. Timers systemd
echo "4Ô∏è‚É£ Timers systemd:"
sudo systemctl list-timers --all 2>/dev/null | grep -E "monero|xmrig" || echo "   ‚úÖ Aucun timer"
echo ""

# 5. Scripts de d√©marrage
echo "5Ô∏è‚É£ Scripts de d√©marrage:"
for file in /etc/rc.local /etc/rc.d/rc.local; do
    if [ -f "$file" ]; then
        echo "   --- $file:"
        sudo cat "$file" | grep -v "^#" | grep -v "^$" || echo "   Vide"
    fi
done
echo ""

# 6. Fichiers de profil (COMPLET)
echo "6Ô∏è‚É£ Fichiers de profil (contenu complet):"
for file in ~/.bashrc ~/.profile ~/.bash_profile /root/.bashrc /root/.profile /root/.bash_profile; do
    if [ -f "$file" ]; then
        echo "   --- $file:"
        if grep -qE "curl|wget|http|sh.*http|xmrig|monero" "$file" 2>/dev/null; then
            grep -E "curl|wget|http|sh.*http|xmrig|monero" "$file" | head -5
        else
            echo "   ‚úÖ Rien de suspect"
        fi
    fi
done
echo ""

# 7. /etc/profile.d
echo "7Ô∏è‚É£ Scripts /etc/profile.d:"
sudo ls -la /etc/profile.d/ 2>/dev/null
for script in /etc/profile.d/*.sh; do
    if [ -f "$script" ]; then
        if grep -qE "curl|wget|http|sh.*http|xmrig|monero" "$script" 2>/dev/null; then
            echo "   ‚ö†Ô∏è  $script suspect:"
            grep -E "curl|wget|http|sh.*http|xmrig|monero" "$script" | head -3
        fi
    fi
done
echo ""

# 8. Contenu du r√©pertoire moneroocean (si existe)
echo "8Ô∏è‚É£ Contenu du r√©pertoire moneroocean:"
if [ -d ~/moneroocean ]; then
    echo "   --- Structure:"
    ls -la ~/moneroocean/ 2>/dev/null | head -20
    echo ""
    echo "   --- Fichiers .sh:"
    find ~/moneroocean -name "*.sh" 2>/dev/null
    echo ""
    echo "   --- Contenu de miner.sh (si existe):"
    if [ -f ~/moneroocean/miner.sh ]; then
        head -50 ~/moneroocean/miner.sh
    fi
    echo ""
    echo "   --- Fichiers r√©cemment modifi√©s:"
    find ~/moneroocean -type f -mtime -1 2>/dev/null | head -10
else
    echo "   ‚úÖ R√©pertoire n'existe pas"
fi
echo ""

# 9. Connexions r√©seau
echo "9Ô∏è‚É£ Connexions r√©seau:"
echo "   --- Connexions √©tablies:"
ss -tunp 2>/dev/null | grep ESTAB | grep -v "127.0.0.1" | head -10 || echo "   ‚úÖ Aucune connexion suspecte"
echo ""
echo "   --- Processus √©coutant:"
ss -tunlp 2>/dev/null | grep LISTEN | head -10
echo ""

# 10. Logs syst√®me
echo "üîü Logs syst√®me (derni√®res 4h):"
echo "   --- Journal systemd:"
sudo journalctl --since "4 hours ago" 2>/dev/null | grep -iE "xmrig|monero|curl.*sh|wget.*sh|bash.*http" | tail -20 || echo "   ‚úÖ Rien dans les logs"
echo ""
echo "   --- Auth log (tentatives SSH):"
sudo tail -50 /var/log/auth.log 2>/dev/null | grep -E "Failed|Accepted" | tail -10 || echo "   Log non disponible"
echo ""

# 11. Fichiers r√©cemment modifi√©s
echo "1Ô∏è‚É£1Ô∏è‚É£ Fichiers r√©cemment modifi√©s (derni√®res 24h):"
echo "   --- Dans /tmp:"
find /tmp -type f -mtime -1 2>/dev/null | head -10 || echo "   ‚úÖ Aucun"
echo ""
echo "   --- Dans ~:"
find ~ -maxdepth 3 -type f -mtime -1 2>/dev/null | grep -v ".git" | head -10 || echo "   ‚úÖ Aucun"
echo ""

# 12. Scripts avec URLs suspectes
echo "1Ô∏è‚É£2Ô∏è‚É£ Scripts contenant des URLs suspectes:"
find /tmp /var/tmp ~ -name "*.sh" -type f -mtime -7 2>/dev/null | while read script; do
    if grep -qE "curl.*http|wget.*http|bash.*http" "$script" 2>/dev/null; then
        echo "   ‚ö†Ô∏è  $script:"
        grep -E "curl.*http|wget.*http|bash.*http" "$script" | head -2
    fi
done || echo "   ‚úÖ Aucun script suspect"
echo ""

# 13. Permissions et propri√©taires
echo "1Ô∏è‚É£3Ô∏è‚É£ Permissions et propri√©taires:"
echo "   --- R√©pertoire home:"
ls -ld ~
echo ""
echo "   --- Fichiers .bashrc, .profile:"
ls -la ~/.bashrc ~/.profile 2>/dev/null || echo "   Fichiers non trouv√©s"
echo ""

# 14. Cl√©s SSH
echo "1Ô∏è‚É£4Ô∏è‚É£ Cl√©s SSH autoris√©es:"
echo "   --- ~/.ssh/authorized_keys:"
wc -l < ~/.ssh/authorized_keys 2>/dev/null || echo "   0"
cat ~/.ssh/authorized_keys 2>/dev/null | while read line; do
    if echo "$line" | grep -qE "curl|wget|http|command="; then
        echo "   ‚ö†Ô∏è  Ligne suspecte d√©tect√©e!"
    fi
done
echo ""
echo "   --- /root/.ssh/authorized_keys:"
sudo wc -l < /root/.ssh/authorized_keys 2>/dev/null || echo "   0"
sudo cat /root/.ssh/authorized_keys 2>/dev/null | while read line; do
    if echo "$line" | grep -v "^#" | grep -qE "curl|wget|http|command="; then
        echo "   ‚ö†Ô∏è  Ligne suspecte d√©tect√©e!"
    fi
done
echo ""

# 15. Processus avec connexions r√©seau
echo "1Ô∏è‚É£5Ô∏è‚É£ Processus avec connexions r√©seau:"
for pid in $(ss -tunp 2>/dev/null | grep ESTAB | awk '{print $6}' | cut -d, -f2 | cut -d= -f2 | sort -u); do
    if [ -n "$pid" ] && [ "$pid" != "users" ]; then
        ps -p "$pid" -o pid,user,cmd 2>/dev/null | tail -1
    fi
done | head -10 || echo "   ‚úÖ Aucun processus suspect"
echo ""

# 16. V√©rifier les fichiers avec setuid
echo "1Ô∏è‚É£6Ô∏è‚É£ Fichiers avec permissions suspectes:"
find ~/moneroocean -perm -4000 -o -perm -2000 2>/dev/null || echo "   ‚úÖ Aucun"
echo ""

# 17. Historique des commandes
echo "1Ô∏è‚É£7Ô∏è‚É£ Historique des commandes (derni√®res 50):"
tail -50 ~/.bash_history 2>/dev/null | grep -E "curl|wget|monero|xmrig|bash.*http" || echo "   ‚úÖ Rien de suspect"
echo ""

echo "=== FIN DU DIAGNOSTIC ==="
echo ""
echo "üìã Points √† v√©rifier:"
echo "   1. Les crontabs (surtout ceux avec curl/wget)"
echo "   2. Les scripts dans /etc/profile.d"
echo "   3. Les fichiers de profil shell"
echo "   4. Les logs syst√®me (journalctl)"
echo "   5. Les connexions r√©seau sortantes"
echo "   6. Les fichiers r√©cemment modifi√©s"
echo ""
echo "üí° Pour surveiller en temps r√©el:"
echo "   watch -n 5 'ps aux | grep -E \"xmrig|monero\" | grep -v grep'"
echo "   sudo tail -f /var/log/malware-detection.log"
