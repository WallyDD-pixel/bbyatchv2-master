#!/bin/bash
# Script de monitoring de la m√©moire et nettoyage automatique des malwares
# Se d√©clenche si la m√©moire disponible est inf√©rieure √† 200 Mi

LOG_FILE="/var/log/memory-malware-monitor.log"
MEMORY_THRESHOLD_MB=200

# Fonction de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | sudo tee -a "$LOG_FILE"
}

# V√©rifier la m√©moire disponible
check_memory() {
    # R√©cup√©rer la m√©moire disponible en MiB
    available_mb=$(free -m | awk 'NR==2{print $7}')
    echo "$available_mb"
}

# Arr√™ter les processus malveillants
kill_malware_processes() {
    log "üîç Recherche de processus malveillants..."
    
    # Liste des processus √† chercher
    malware_patterns=("xmrig" "monero" "moneroocean" "systemwatcher" "systemdpw" "system-check" "scanner_linux")
    
    found=false
    for pattern in "${malware_patterns[@]}"; do
        if pgrep -f "$pattern" > /dev/null 2>&1; then
            log "‚ö†Ô∏è  Processus malveillant d√©tect√©: $pattern"
            sudo pkill -9 -f "$pattern" 2>/dev/null || true
            found=true
            sleep 1
        fi
    done
    
    if [ "$found" = true ]; then
        log "‚úÖ Processus malveillants arr√™t√©s"
        return 0
    else
        log "‚úÖ Aucun processus malveillant d√©tect√©"
        return 1
    fi
}

# Supprimer les r√©pertoires et fichiers malveillants
remove_malware_files() {
    log "üóëÔ∏è  Recherche de fichiers/r√©pertoires malveillants..."
    
    malware_dirs=(
        "$HOME/moneroocean"
        "/root/moneroocean"
        "/tmp/moneroocean"
        "/var/tmp/moneroocean"
        "/opt/moneroocean"
        "/tmp/.systemdpw"
        "/root/.systemdpw"
        "$HOME/.systemdpw"
        "/tmp/.system"
        "/root/.system"
        "$HOME/.system"
    )
    
    found=false
    for dir in "${malware_dirs[@]}"; do
        if [ -d "$dir" ] || [ -f "$dir" ]; then
            log "‚ö†Ô∏è  Fichier/r√©pertoire suspect d√©tect√©: $dir"
            sudo rm -rf "$dir" 2>/dev/null || true
            found=true
        fi
    done
    
    # Chercher des fichiers suspects dans /tmp
    sudo find /tmp -maxdepth 2 -name "*system-check*" -o -name "*scanner_linux*" 2>/dev/null | while read file; do
        if [ -f "$file" ]; then
            log "‚ö†Ô∏è  Fichier suspect d√©tect√©: $file"
            sudo rm -f "$file" 2>/dev/null || true
            found=true
        fi
    done
    
    if [ "$found" = true ]; then
        log "‚úÖ Fichiers/r√©pertoires malveillants supprim√©s"
        return 0
    else
        log "‚úÖ Aucun fichier/r√©pertoire malveillant d√©tect√©"
        return 1
    fi
}

# Nettoyer les crontabs suspects
clean_crontabs() {
    log "üßπ Nettoyage des crontabs suspects..."
    
    malware_keywords=("xmrig" "monero" "systemwatcher" "systemdpw" "system-check" "scanner_linux" "curl.*sh" "wget.*sh")
    
    cleaned=false
    
    # Nettoyer crontab utilisateur
    if crontab -l 2>/dev/null | grep -qE "$(IFS='|'; echo "${malware_keywords[*]}")"; then
        log "‚ö†Ô∏è  Crontab utilisateur suspect d√©tect√©"
        crontab -l 2>/dev/null | grep -vE "$(IFS='|'; echo "${malware_keywords[*]}")" | crontab - 2>/dev/null || true
        cleaned=true
    fi
    
    # Nettoyer crontab root
    if sudo crontab -l 2>/dev/null | grep -qE "$(IFS='|'; echo "${malware_keywords[*]}")"; then
        log "‚ö†Ô∏è  Crontab root suspect d√©tect√©"
        sudo crontab -l 2>/dev/null | grep -vE "$(IFS='|'; echo "${malware_keywords[*]}")" | sudo crontab - 2>/dev/null || true
        cleaned=true
    fi
    
    if [ "$cleaned" = true ]; then
        log "‚úÖ Crontabs nettoy√©s"
        return 0
    else
        log "‚úÖ Crontabs propres"
        return 1
    fi
}

# Red√©marrer les services
restart_services() {
    log "üîÑ Red√©marrage des services..."
    
    # Red√©marrer PM2
    if command -v pm2 > /dev/null 2>&1; then
        log "Red√©marrage de PM2..."
        pm2 restart bbyatch 2>/dev/null || true
        sleep 2
    fi
    
    # Red√©marrer Nginx
    if command -v nginx > /dev/null 2>&1; then
        log "Red√©marrage de Nginx..."
        sudo systemctl restart nginx 2>/dev/null || true
        sleep 1
    fi
    
    log "‚úÖ Services red√©marr√©s"
}

# Fonction principale
main() {
    log "=== D√©but du monitoring ==="
    
    # V√©rifier la m√©moire
    available_mb=$(check_memory)
    log "M√©moire disponible: ${available_mb} MiB"
    
    # Si la m√©moire est suffisante, ne rien faire
    if [ "$available_mb" -ge "$MEMORY_THRESHOLD_MB" ]; then
        log "‚úÖ M√©moire suffisante (${available_mb} MiB >= ${MEMORY_THRESHOLD_MB} MiB)"
        log "=== Fin du monitoring (aucune action) ==="
        return 0
    fi
    
    log "‚ö†Ô∏è  ALERTE: M√©moire faible (${available_mb} MiB < ${MEMORY_THRESHOLD_MB} MiB)"
    log "üîç D√©clenchement de la v√©rification de malware..."
    
    # Variables pour suivre si des actions ont √©t√© prises
    action_taken=false
    
    # V√©rifier et arr√™ter les processus malveillants
    if kill_malware_processes; then
        action_taken=true
    fi
    
    # Supprimer les fichiers malveillants
    if remove_malware_files; then
        action_taken=true
    fi
    
    # Nettoyer les crontabs
    if clean_crontabs; then
        action_taken=true
    fi
    
    # Si des actions ont √©t√© prises, red√©marrer les services
    if [ "$action_taken" = true ]; then
        log "üîÑ Des malwares ont √©t√© d√©tect√©s et supprim√©s, red√©marrage des services..."
        restart_services
        
        # V√©rifier la m√©moire apr√®s nettoyage
        sleep 3
        new_available_mb=$(check_memory)
        log "M√©moire disponible apr√®s nettoyage: ${new_available_mb} MiB"
    else
        log "‚ÑπÔ∏è  Aucun malware d√©tect√©, mais m√©moire faible"
        log "üí° V√©rifiez les autres processus qui utilisent la m√©moire"
        
        # Afficher les processus qui utilisent le plus de m√©moire
        log "Top 5 processus utilisant la m√©moire:"
        ps aux --sort=-%mem | head -6 | tail -5 | while read line; do
            log "  $line"
        done
    fi
    
    log "=== Fin du monitoring ==="
    echo "" # Ligne vide pour s√©parer les ex√©cutions
}

# Ex√©cuter le script
main
