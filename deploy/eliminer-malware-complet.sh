#!/bin/bash
# Script complet pour √©liminer le malware moneroocean et trouver la source

set -e

echo "üîí === √âLIMINATION COMPL√àTE DU MALWARE ==="
echo ""

# 1. Arr√™ter imm√©diatement tous les processus
echo "1Ô∏è‚É£ Arr√™t des processus malveillants..."
sudo pkill -9 -f xmrig 2>/dev/null || true
sudo pkill -9 -f monero 2>/dev/null || true
sudo pkill -9 -f moneroocean 2>/dev/null || true
sudo pkill -9 -f systemwatcher 2>/dev/null || true
sudo pkill -9 -f systemdpw 2>/dev/null || true
sudo pkill -9 -f system-check 2>/dev/null || true
sudo pkill -9 -f scanner_linux 2>/dev/null || true
sudo pkill -9 -f "curl.*monero" 2>/dev/null || true
sudo pkill -9 -f "wget.*monero" 2>/dev/null || true
sleep 2
echo "‚úÖ Processus arr√™t√©s"
echo ""

# 2. Supprimer les r√©pertoires malveillants
echo "2Ô∏è‚É£ Suppression des r√©pertoires malveillants..."
for dir in ~/moneroocean /root/moneroocean /tmp/moneroocean /var/tmp/moneroocean /opt/moneroocean /tmp/.systemdpw /root/.systemdpw ~/.systemdpw /tmp/.system /root/.system ~/.system; do
    if [ -d "$dir" ]; then
        echo "   Suppression de $dir..."
        sudo rm -rf "$dir" 2>/dev/null || true
        echo "   ‚úÖ Supprim√©"
    fi
done

# Supprimer les fichiers malveillants
echo "   Recherche de fichiers malveillants..."
sudo find /tmp -name "*system-check*" -o -name "*scanner_linux*" 2>/dev/null | while read file; do
    echo "   Suppression de $file..."
    sudo rm -f "$file" 2>/dev/null || true
done
echo ""

# 3. Nettoyer TOUS les crontabs (tous les utilisateurs)
echo "3Ô∏è‚É£ Nettoyage des crontabs (tous utilisateurs)..."
# Sauvegarder d'abord
sudo crontab -l > /tmp/crontab_root_backup_$(date +%Y%m%d_%H%M%S).txt 2>/dev/null || true
crontab -l > /tmp/crontab_user_backup_$(date +%Y%m%d_%H%M%S).txt 2>/dev/null || true

# Nettoyer crontab root
if sudo crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh"; then
    echo "   ‚ö†Ô∏è  Crontab root suspect d√©tect√© !"
    sudo crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|moneroocean" | sudo crontab - 2>/dev/null || true
    echo "   ‚úÖ Crontab root nettoy√©"
fi

# Nettoyer crontab utilisateur actuel
if crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh"; then
    echo "   ‚ö†Ô∏è  Crontab utilisateur suspect d√©tect√© !"
    crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|moneroocean" | crontab - 2>/dev/null || true
    echo "   ‚úÖ Crontab utilisateur nettoy√©"
fi

# Nettoyer tous les autres utilisateurs
for user in $(cut -f1 -d: /etc/passwd); do
    if sudo crontab -u "$user" -l 2>/dev/null | grep -qE "xmrig|monero|systemwatcher|systemdpw"; then
        echo "   ‚ö†Ô∏è  Crontab suspect pour $user !"
        sudo crontab -u "$user" -l 2>/dev/null | grep -vE "xmrig|monero|systemwatcher|systemdpw|curl.*sh|wget.*sh" | sudo crontab -u "$user" - 2>/dev/null || true
        echo "   ‚úÖ Crontab de $user nettoy√©"
    fi
done

# Nettoyer /etc/crontab
if [ -f /etc/crontab ] && sudo grep -qE "xmrig|monero" /etc/crontab 2>/dev/null; then
    echo "   ‚ö†Ô∏è  /etc/crontab suspect !"
    sudo sed -i '/xmrig\|monero/d' /etc/crontab
    echo "   ‚úÖ /etc/crontab nettoy√©"
fi

# Nettoyer /var/spool/cron/crontabs
for crontab_file in /var/spool/cron/crontabs/*; do
    if [ -f "$crontab_file" ] && sudo grep -qE "xmrig|monero" "$crontab_file" 2>/dev/null; then
        echo "   ‚ö†Ô∏è  $crontab_file suspect !"
        sudo sed -i '/xmrig\|monero/d' "$crontab_file"
        echo "   ‚úÖ $crontab_file nettoy√©"
    fi
done
echo ""

# 4. D√©sactiver et supprimer les services systemd
echo "4Ô∏è‚É£ Nettoyage des services systemd..."
for service in moneroocean_miner xmrig miner monero; do
    if sudo systemctl list-units --all 2>/dev/null | grep -q "$service"; then
        echo "   ‚ö†Ô∏è  Service $service d√©tect√© !"
        sudo systemctl stop "$service" 2>/dev/null || true
        sudo systemctl disable "$service" 2>/dev/null || true
        sudo systemctl mask "$service" 2>/dev/null || true
        echo "   ‚úÖ Service $service d√©sactiv√©"
    fi
done

# Supprimer les fichiers de service
sudo rm -f /etc/systemd/system/*monero*.service
sudo rm -f /etc/systemd/system/*xmrig*.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/*monero*.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/*xmrig*.service
sudo systemctl daemon-reload
sudo systemctl reset-failed
echo ""

# 5. Nettoyer les timers systemd
echo "5Ô∏è‚É£ Nettoyage des timers systemd..."
sudo systemctl list-timers --all 2>/dev/null | grep -E "monero|xmrig" && {
    sudo systemctl stop *.timer 2>/dev/null || true
    sudo rm -f /etc/systemd/system/*monero*.timer
    sudo rm -f /etc/systemd/system/*xmrig*.timer
    sudo systemctl daemon-reload
    echo "   ‚úÖ Timers supprim√©s"
} || echo "   ‚úÖ Aucun timer suspect"
echo ""

# 6. Nettoyer les scripts de d√©marrage
echo "6Ô∏è‚É£ Nettoyage des scripts de d√©marrage..."
for file in /etc/rc.local /etc/rc.d/rc.local; do
    if [ -f "$file" ] && sudo grep -qE "xmrig|monero" "$file" 2>/dev/null; then
        echo "   ‚ö†Ô∏è  $file suspect !"
        sudo sed -i '/xmrig\|monero/d' "$file"
        echo "   ‚úÖ $file nettoy√©"
    fi
done
echo ""

# 7. Nettoyer les fichiers de profil shell
echo "7Ô∏è‚É£ Nettoyage des fichiers de profil..."
for file in ~/.bashrc ~/.profile ~/.bash_profile /root/.bashrc /root/.profile /root/.bash_profile /etc/profile; do
    if [ -f "$file" ] && grep -qE "xmrig|monero" "$file" 2>/dev/null; then
        echo "   ‚ö†Ô∏è  $file suspect !"
        sudo sed -i '/xmrig\|monero/d' "$file" 2>/dev/null || true
        echo "   ‚úÖ $file nettoy√©"
    fi
done
echo ""

# 8. Nettoyer /etc/profile.d
echo "8Ô∏è‚É£ Nettoyage /etc/profile.d..."
sudo rm -f /etc/profile.d/*monero*.sh
sudo rm -f /etc/profile.d/*xmrig*.sh
sudo find /etc/profile.d -name "*.sh" -exec grep -l "xmrig\|monero" {} \; 2>/dev/null | while read script; do
    echo "   ‚ö†Ô∏è  Script suspect: $script"
    sudo sed -i '/xmrig\|monero/d' "$script"
    echo "   ‚úÖ $script nettoy√©"
done
echo ""

# 9. Nettoyer /tmp et /var/tmp
echo "9Ô∏è‚É£ Nettoyage /tmp et /var/tmp..."
sudo find /tmp /var/tmp -name "*xmrig*" -o -name "*monero*" 2>/dev/null | xargs sudo rm -rf 2>/dev/null || true
echo "   ‚úÖ Nettoy√©"
echo ""

# 10. RECHERCHE DE LA SOURCE
echo "üîç === RECHERCHE DE LA SOURCE ==="
echo ""

# 10.1 V√©rifier les processus actifs
echo "10.1 Processus actifs:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "   ‚úÖ Aucun processus"
echo ""

# 10.2 V√©rifier les crontabs suspects
echo "10.2 Crontabs suspects:"
echo "   Root:"
sudo crontab -l 2>/dev/null | grep -E "curl|wget|sh.*http" || echo "   ‚úÖ Rien"
echo "   Utilisateur:"
crontab -l 2>/dev/null | grep -E "curl|wget|sh.*http" || echo "   ‚úÖ Rien"
echo ""

# 10.3 V√©rifier les services
echo "10.3 Services systemd:"
sudo systemctl list-units --all 2>/dev/null | grep -E "monero|xmrig" || echo "   ‚úÖ Aucun service"
echo ""

# 10.4 V√©rifier les scripts r√©cents
echo "10.4 Scripts r√©cemment modifi√©s:"
find /tmp /var/tmp ~ -name "*.sh" -type f -mtime -1 2>/dev/null | head -5 || echo "   ‚úÖ Aucun"
echo ""

# 10.5 V√©rifier les connexions r√©seau
echo "10.5 Connexions r√©seau suspectes:"
ss -tunp 2>/dev/null | grep -E "443|80" | grep -v "127.0.0.1" | head -5 || echo "   ‚úÖ Aucune connexion suspecte"
echo ""

# 10.6 V√©rifier les cl√©s SSH
echo "10.6 Cl√©s SSH autoris√©es:"
echo "   ~/.ssh/authorized_keys: $(wc -l < ~/.ssh/authorized_keys 2>/dev/null || echo 0) cl√©s"
echo "   /root/.ssh/authorized_keys: $(sudo wc -l < /root/.ssh/authorized_keys 2>/dev/null || echo 0) cl√©s"
echo ""

# 11. INSTALLER/METTRE √Ä JOUR Fail2Ban
echo "11Ô∏è‚É£ V√©rification Fail2Ban..."
if ! command -v fail2ban-client &> /dev/null; then
    echo "   Installation de Fail2Ban..."
    sudo apt-get update -qq
    sudo apt-get install -y fail2ban
    sudo systemctl enable fail2ban
    sudo systemctl start fail2ban
    echo "   ‚úÖ Fail2Ban install√©"
else
    echo "   ‚úÖ Fail2Ban d√©j√† install√©"
    sudo systemctl restart fail2ban 2>/dev/null || true
fi
echo ""

# 12. CR√âER UN SCRIPT DE MONITORING RENFORC√â
echo "12Ô∏è‚É£ Installation du script de monitoring..."
sudo tee /usr/local/bin/detect-malware.sh > /dev/null <<'EOF'
#!/bin/bash
# Script de d√©tection et suppression automatique du malware

LOG_FILE="/var/log/malware-detection.log"

# D√©tecter les processus
if pgrep -f xmrig > /dev/null || pgrep -f "moneroocean" > /dev/null; then
    echo "$(date): ALERTE - Processus malware d√©tect√©!" | sudo tee -a "$LOG_FILE"
    sudo pkill -9 -f xmrig
    sudo pkill -9 -f moneroocean
    sudo pkill -9 -f "curl.*monero"
    sudo pkill -9 -f "wget.*monero"
fi

# D√©tecter les r√©pertoires
if [ -d ~/moneroocean ] || [ -d /root/moneroocean ]; then
    echo "$(date): ALERTE - R√©pertoire moneroocean d√©tect√©!" | sudo tee -a "$LOG_FILE"
    sudo rm -rf ~/moneroocean /root/moneroocean /tmp/moneroocean /var/tmp/moneroocean
fi

# D√©tecter les crontabs suspects
if crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh"; then
    echo "$(date): ALERTE - Crontab suspect d√©tect√©!" | sudo tee -a "$LOG_FILE"
    crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh" | crontab - 2>/dev/null || true
fi

if sudo crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh"; then
    echo "$(date): ALERTE - Crontab root suspect d√©tect√©!" | sudo tee -a "$LOG_FILE"
    sudo crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh" | sudo crontab - 2>/dev/null || true
fi
EOF

sudo chmod +x /usr/local/bin/detect-malware.sh

# Ajouter au crontab root (toutes les 2 minutes)
(sudo crontab -l 2>/dev/null | grep -v "detect-malware"; echo "*/2 * * * * /usr/local/bin/detect-malware.sh") | sudo crontab -
echo "   ‚úÖ Script de monitoring install√© (v√©rifie toutes les 2 minutes)"
echo ""

# 13. V√âRIFICATION FINALE
echo "=== V√âRIFICATION FINALE ==="
echo ""
echo "Processus:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "‚úÖ Aucun processus"
echo ""
echo "Crontabs:"
sudo crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "‚úÖ Crontab root propre"
crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "‚úÖ Crontab user propre"
echo ""
echo "Services:"
sudo systemctl list-units --all 2>/dev/null | grep -E "monero|xmrig" || echo "‚úÖ Aucun service"
echo ""
echo "R√©pertoires:"
[ -d ~/moneroocean ] && echo "‚ùå ~/moneroocean existe encore" || echo "‚úÖ ~/moneroocean supprim√©"
[ -d /root/moneroocean ] && echo "‚ùå /root/moneroocean existe encore" || echo "‚úÖ /root/moneroocean supprim√©"
echo ""

echo "=== NETTOYAGE TERMIN√â ==="
echo ""
echo "üìã Actions recommand√©es:"
echo "   1. Changez TOUS les mots de passe (SSH, root, utilisateurs)"
echo "   2. V√©rifiez les cl√©s SSH: cat ~/.ssh/authorized_keys"
echo "   3. Limitez l'acc√®s SSH: sudo ufw allow from VOTRE_IP to any port 22"
echo "   4. D√©sactivez l'authentification root par SSH si possible"
echo "   5. Surveillez les logs: tail -f /var/log/malware-detection.log"
echo "   6. Le script de monitoring v√©rifie toutes les 2 minutes"
echo ""
echo "üîí Le malware sera automatiquement supprim√© s'il revient."
