#!/bin/bash
# Script pour éliminer définitivement le malware Monero

set -e

echo "=== ÉLIMINATION DÉFINITIVE DU MALWARE ==="
echo ""

# 1. Arrêter tous les processus
echo "1. Arrêt des processus..."
sudo pkill -9 -f xmrig || true
sudo pkill -9 -f monero || true
sleep 2

# 2. Supprimer les crontabs
echo "2. Nettoyage des crontabs..."
# Sauvegarder d'abord
sudo crontab -l > /tmp/crontab_root_backup.txt 2>/dev/null || true
crontab -l > /tmp/crontab_user_backup.txt 2>/dev/null || true

# Nettoyer
sudo crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*monero|wget.*monero" | sudo crontab - 2>/dev/null || true
crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*monero|wget.*monero" | crontab - 2>/dev/null || true

# Nettoyer tous les utilisateurs
for user in $(cut -f1 -d: /etc/passwd); do
    sudo crontab -u "$user" -l 2>/dev/null | grep -vE "xmrig|monero" | sudo crontab -u "$user" - 2>/dev/null || true
done
echo "✅ Crontabs nettoyés"

# 3. Désactiver et supprimer les services systemd
echo "3. Nettoyage des services systemd..."
sudo systemctl stop moneroocean_miner.service 2>/dev/null || true
sudo systemctl disable moneroocean_miner.service 2>/dev/null || true
sudo systemctl mask moneroocean_miner.service 2>/dev/null || true
sudo rm -f /etc/systemd/system/moneroocean_miner.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/moneroocean_miner.service
sudo systemctl daemon-reload
sudo systemctl reset-failed
echo "✅ Services nettoyés"

# 4. Supprimer les timers
echo "4. Nettoyage des timers..."
sudo systemctl stop *.timer 2>/dev/null || true
sudo rm -f /etc/systemd/system/*monero*.timer
sudo rm -f /etc/systemd/system/*xmrig*.timer
sudo systemctl daemon-reload
echo "✅ Timers nettoyés"

# 5. Nettoyer les scripts de démarrage
echo "5. Nettoyage des scripts de démarrage..."
if [ -f /etc/rc.local ]; then
    sudo sed -i '/xmrig\|monero/d' /etc/rc.local
fi
if [ -f /etc/rc.d/rc.local ]; then
    sudo sed -i '/xmrig\|monero/d' /etc/rc.d/rc.local
fi
echo "✅ Scripts de démarrage nettoyés"

# 6. Nettoyer les fichiers de profil shell
echo "6. Nettoyage des fichiers de profil..."
for file in ~/.bashrc ~/.profile ~/.bash_profile /root/.bashrc /root/.profile /root/.bash_profile; do
    if [ -f "$file" ]; then
        sudo sed -i '/xmrig\|monero/d' "$file" 2>/dev/null || true
    fi
done
echo "✅ Fichiers de profil nettoyés"

# 7. Nettoyer /etc/profile.d
echo "7. Nettoyage /etc/profile.d..."
sudo rm -f /etc/profile.d/*monero*.sh
sudo rm -f /etc/profile.d/*xmrig*.sh
echo "✅ /etc/profile.d nettoyé"

# 8. Supprimer le répertoire moneroocean
echo "8. Suppression du répertoire moneroocean..."
if [ -d ~/moneroocean ]; then
    sudo rm -rf ~/moneroocean
    echo "✅ Répertoire supprimé"
else
    echo "⚠️ Répertoire déjà supprimé"
fi

# 9. Supprimer les fichiers dans /tmp
echo "9. Nettoyage /tmp..."
sudo find /tmp /var/tmp -name "*xmrig*" -o -name "*monero*" 2>/dev/null | xargs sudo rm -rf 2>/dev/null || true
echo "✅ /tmp nettoyé"

# 10. Installer Fail2Ban si pas déjà fait (protection)
echo "10. Vérification Fail2Ban..."
if ! command -v fail2ban-client &> /dev/null; then
    echo "Installation de Fail2Ban..."
    sudo apt-get update -qq
    sudo apt-get install -y fail2ban
    sudo systemctl enable fail2ban
    sudo systemctl start fail2ban
    echo "✅ Fail2Ban installé"
else
    echo "✅ Fail2Ban déjà installé"
fi

# 11. Créer un script de monitoring pour détecter le retour
echo "11. Création d'un script de détection..."
sudo tee /usr/local/bin/detect-malware.sh > /dev/null <<'EOF'
#!/bin/bash
# Détection automatique du malware
if pgrep -f xmrig > /dev/null || pgrep -f monero > /dev/null; then
    echo "ALERTE: Malware détecté!" | logger -t malware-alert
    sudo pkill -9 -f xmrig
    sudo pkill -9 -f monero
    # Envoyer une alerte (optionnel)
fi
if [ -d ~/moneroocean ] || [ -d /root/moneroocean ]; then
    echo "ALERTE: Répertoire moneroocean détecté!" | logger -t malware-alert
    sudo rm -rf ~/moneroocean /root/moneroocean
fi
EOF
sudo chmod +x /usr/local/bin/detect-malware.sh

# Ajouter au crontab root pour vérifier toutes les 5 minutes
(sudo crontab -l 2>/dev/null | grep -v "detect-malware"; echo "*/5 * * * * /usr/local/bin/detect-malware.sh") | sudo crontab -
echo "✅ Script de détection installé"

# 12. Vérification finale
echo ""
echo "=== VÉRIFICATION FINALE ==="
echo "Processus:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "✅ Aucun processus"
echo ""
echo "Crontabs:"
sudo crontab -l 2>/dev/null | grep -E "xmrig|monero" || echo "✅ Crontab root propre"
crontab -l 2>/dev/null | grep -E "xmrig|monero" || echo "✅ Crontab user propre"
echo ""
echo "Services:"
sudo systemctl list-units --all | grep -E "monero|xmrig" || echo "✅ Aucun service"
echo ""
echo "Répertoires:"
[ -d ~/moneroocean ] && echo "❌ ~/moneroocean existe encore" || echo "✅ ~/moneroocean supprimé"

echo ""
echo "=== NETTOYAGE TERMINÉ ==="
echo ""
echo "Le script de détection vérifiera toutes les 5 minutes."
echo "Si le malware revient, il sera automatiquement supprimé."
