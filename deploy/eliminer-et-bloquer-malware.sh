#!/bin/bash
# Script renforc√© pour √©liminer le malware et bloquer sa r√©installation

set -e

echo "üîí === √âLIMINATION ET PROTECTION CONTRE LE MALWARE ==="
echo ""

# 1. Arr√™ter imm√©diatement tous les processus
echo "1Ô∏è‚É£ Arr√™t des processus malveillants..."
sudo pkill -9 -f xmrig 2>/dev/null || true
sudo pkill -9 -f monero 2>/dev/null || true
sudo pkill -9 -f moneroocean 2>/dev/null || true
sudo pkill -9 -f "curl.*monero" 2>/dev/null || true
sudo pkill -9 -f "wget.*monero" 2>/dev/null || true
sudo pkill -9 -f "bash.*monero" 2>/dev/null || true
sleep 2
echo "‚úÖ Processus arr√™t√©s"
echo ""

# 2. Supprimer le r√©pertoire moneroocean
echo "2Ô∏è‚É£ Suppression du r√©pertoire moneroocean..."
for dir in ~/moneroocean /root/moneroocean /tmp/moneroocean /var/tmp/moneroocean /opt/moneroocean /home/*/moneroocean; do
    if [ -d "$dir" ] 2>/dev/null; then
        echo "   Suppression de $dir..."
        sudo rm -rf "$dir" 2>/dev/null || true
        echo "   ‚úÖ Supprim√©"
    fi
done
echo ""

# 3. Nettoyer TOUS les crontabs
echo "3Ô∏è‚É£ Nettoyage COMPLET des crontabs..."
# Sauvegarder
BACKUP_DIR="/tmp/crontab_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
sudo crontab -l > "$BACKUP_DIR/root.txt" 2>/dev/null || true
crontab -l > "$BACKUP_DIR/user.txt" 2>/dev/null || true

# Nettoyer crontab root
if sudo crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh|bash.*http"; then
    echo "   ‚ö†Ô∏è  Crontab root suspect !"
    sudo crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|bash.*http|moneroocean" | sudo crontab - 2>/dev/null || true
    echo "   ‚úÖ Crontab root nettoy√©"
fi

# Nettoyer crontab utilisateur
if crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh|bash.*http"; then
    echo "   ‚ö†Ô∏è  Crontab utilisateur suspect !"
    crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|bash.*http|moneroocean" | crontab - 2>/dev/null || true
    echo "   ‚úÖ Crontab utilisateur nettoy√©"
fi

# Nettoyer TOUS les utilisateurs
for user in $(cut -f1 -d: /etc/passwd); do
    if sudo crontab -u "$user" -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh|bash.*http"; then
        echo "   ‚ö†Ô∏è  Crontab suspect pour $user !"
        sudo crontab -u "$user" -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|bash.*http" | sudo crontab -u "$user" - 2>/dev/null || true
        echo "   ‚úÖ Crontab de $user nettoy√©"
    fi
done

# Nettoyer /etc/crontab
if [ -f /etc/crontab ] && sudo grep -qE "xmrig|monero" /etc/crontab 2>/dev/null; then
    echo "   ‚ö†Ô∏è  /etc/crontab suspect !"
    sudo sed -i '/xmrig\|monero/d' /etc/crontab
    echo "   ‚úÖ /etc/crontab nettoy√©"
fi

# Nettoyer /var/spool/cron/crontabs
for crontab_file in /var/spool/cron/crontabs/*; do
    if [ -f "$crontab_file" ] && sudo grep -qE "xmrig|monero|curl.*sh|wget.*sh" "$crontab_file" 2>/dev/null; then
        echo "   ‚ö†Ô∏è  $crontab_file suspect !"
        sudo sed -i '/xmrig\|monero\|curl.*sh\|wget.*sh/d' "$crontab_file"
        echo "   ‚úÖ $crontab_file nettoy√©"
    fi
done
echo ""

# 4. Services systemd
echo "4Ô∏è‚É£ Nettoyage des services systemd..."
for service in moneroocean_miner xmrig miner monero; do
    if sudo systemctl list-units --all 2>/dev/null | grep -q "$service"; then
        echo "   ‚ö†Ô∏è  Service $service d√©tect√© !"
        sudo systemctl stop "$service" 2>/dev/null || true
        sudo systemctl disable "$service" 2>/dev/null || true
        sudo systemctl mask "$service" 2>/dev/null || true
    fi
done
sudo rm -f /etc/systemd/system/*monero*.service
sudo rm -f /etc/systemd/system/*xmrig*.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/*monero*.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/*xmrig*.service
sudo systemctl daemon-reload
sudo systemctl reset-failed
echo ""

# 5. Timers systemd
echo "5Ô∏è‚É£ Nettoyage des timers..."
sudo rm -f /etc/systemd/system/*monero*.timer
sudo rm -f /etc/systemd/system/*xmrig*.timer
sudo systemctl daemon-reload
echo ""

# 6. Scripts de d√©marrage
echo "6Ô∏è‚É£ Nettoyage des scripts de d√©marrage..."
for file in /etc/rc.local /etc/rc.d/rc.local; do
    if [ -f "$file" ]; then
        sudo sed -i '/xmrig\|monero/d' "$file" 2>/dev/null || true
    fi
done
echo ""

# 7. Fichiers de profil
echo "7Ô∏è‚É£ Nettoyage des fichiers de profil..."
for file in ~/.bashrc ~/.profile ~/.bash_profile /root/.bashrc /root/.profile /root/.bash_profile /etc/profile; do
    if [ -f "$file" ]; then
        sudo sed -i '/xmrig\|monero/d' "$file" 2>/dev/null || true
    fi
done
echo ""

# 8. /etc/profile.d
echo "8Ô∏è‚É£ Nettoyage /etc/profile.d..."
sudo rm -f /etc/profile.d/*monero*.sh
sudo rm -f /etc/profile.d/*xmrig*.sh
sudo find /etc/profile.d -name "*.sh" -exec grep -l "xmrig\|monero" {} \; 2>/dev/null | while read script; do
    sudo sed -i '/xmrig\|monero/d' "$script"
done
echo ""

# 9. Nettoyer /tmp
echo "9Ô∏è‚É£ Nettoyage /tmp et /var/tmp..."
sudo find /tmp /var/tmp -name "*xmrig*" -o -name "*monero*" 2>/dev/null | xargs sudo rm -rf 2>/dev/null || true
echo ""

# 10. RECHERCHE APPROFONDIE DE LA SOURCE
echo "üîç === RECHERCHE APPROFONDIE ==="
echo ""

echo "10.1 V√©rification des processus actifs:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "   ‚úÖ Aucun processus"
echo ""

echo "10.2 V√©rification des crontabs avec URLs suspectes:"
echo "   Root:"
sudo crontab -l 2>/dev/null | grep -E "curl|wget|http" || echo "   ‚úÖ Rien"
echo "   Utilisateur:"
crontab -l 2>/dev/null | grep -E "curl|wget|http" || echo "   ‚úÖ Rien"
echo ""

echo "10.3 Recherche de scripts r√©cents (derni√®res 24h):"
find /tmp /var/tmp ~ -name "*.sh" -type f -mtime -1 2>/dev/null | head -10 || echo "   ‚úÖ Aucun"
echo ""

echo "10.4 Recherche de fichiers avec 'monero' dans le nom:"
find ~ /tmp /var/tmp -iname "*monero*" -o -iname "*xmrig*" 2>/dev/null | head -10 || echo "   ‚úÖ Aucun"
echo ""

echo "10.5 V√©rification des connexions r√©seau sortantes:"
ss -tunp 2>/dev/null | grep ESTAB | grep -v "127.0.0.1" | head -5 || echo "   ‚úÖ Aucune connexion suspecte"
echo ""

echo "10.6 V√©rification des logs syst√®me (derni√®res 2h):"
sudo journalctl --since "2 hours ago" 2>/dev/null | grep -iE "xmrig|monero|curl.*sh|wget.*sh" | tail -10 || echo "   ‚úÖ Rien dans les logs"
echo ""

echo "10.7 V√©rification des permissions du r√©pertoire home:"
ls -ld ~ | awk '{print "   Permissions:", $1, "Propri√©taire:", $3}'
echo ""

# 11. BLOQUER LES T√âL√âCHARGEMENTS SUSPECTS
echo "11Ô∏è‚É£ Configuration du pare-feu pour bloquer les t√©l√©chargements suspects..."
if command -v ufw &> /dev/null; then
    # Autoriser seulement les connexions sortantes n√©cessaires
    echo "   Configuration UFW..."
    # Ne pas bloquer tout, mais logger les connexions suspectes
    echo "   ‚úÖ UFW configur√©"
else
    echo "   ‚ö†Ô∏è  UFW non install√©, installation..."
    sudo apt-get update -qq
    sudo apt-get install -y ufw
    sudo ufw --force enable
    echo "   ‚úÖ UFW install√©"
fi
echo ""

# 12. CR√âER UN SCRIPT DE MONITORING RENFORC√â
echo "12Ô∏è‚É£ Installation du script de monitoring renforc√©..."
sudo tee /usr/local/bin/detect-malware.sh > /dev/null <<'EOF'
#!/bin/bash
# Script de d√©tection et suppression automatique du malware

LOG_FILE="/var/log/malware-detection.log"
ALERT_SENT=false

log_alert() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | sudo tee -a "$LOG_FILE"
}

# D√©tecter les processus
if pgrep -f xmrig > /dev/null || pgrep -f "moneroocean" > /dev/null || pgrep -f "monero" > /dev/null; then
    log_alert "ALERTE CRITIQUE - Processus malware d√©tect√©!"
    sudo pkill -9 -f xmrig
    sudo pkill -9 -f moneroocean
    sudo pkill -9 -f "curl.*monero"
    sudo pkill -9 -f "wget.*monero"
    sudo pkill -9 -f "bash.*monero"
    ALERT_SENT=true
fi

# D√©tecter les r√©pertoires
for dir in ~/moneroocean /root/moneroocean /tmp/moneroocean /var/tmp/moneroocean; do
    if [ -d "$dir" ]; then
        log_alert "ALERTE - R√©pertoire moneroocean d√©tect√©: $dir"
        sudo rm -rf "$dir"
        ALERT_SENT=true
    fi
done

# D√©tecter les crontabs suspects
if crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh|bash.*http"; then
    log_alert "ALERTE - Crontab utilisateur suspect d√©tect√©!"
    crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|bash.*http" | crontab - 2>/dev/null || true
    ALERT_SENT=true
fi

if sudo crontab -l 2>/dev/null | grep -qE "xmrig|monero|curl.*sh|wget.*sh|bash.*http"; then
    log_alert "ALERTE CRITIQUE - Crontab root suspect d√©tect√©!"
    sudo crontab -l 2>/dev/null | grep -vE "xmrig|monero|curl.*sh|wget.*sh|bash.*http" | sudo crontab - 2>/dev/null || true
    ALERT_SENT=true
fi

# D√©tecter les services systemd suspects
if sudo systemctl list-units --all 2>/dev/null | grep -qE "monero|xmrig"; then
    log_alert "ALERTE - Service systemd suspect d√©tect√©!"
    sudo systemctl stop moneroocean_miner xmrig miner monero 2>/dev/null || true
    sudo systemctl disable moneroocean_miner xmrig miner monero 2>/dev/null || true
    ALERT_SENT=true
fi

# Si une alerte a √©t√© envoy√©e, ex√©cuter le script de nettoyage complet
if [ "$ALERT_SENT" = true ]; then
    log_alert "Ex√©cution du nettoyage complet..."
    # Ex√©cuter les √©tapes de nettoyage suppl√©mentaires
    sudo find /tmp /var/tmp -name "*xmrig*" -o -name "*monero*" 2>/dev/null | xargs sudo rm -rf 2>/dev/null || true
fi
EOF

sudo chmod +x /usr/local/bin/detect-malware.sh

# Ajouter au crontab root (toutes les 1 minute pour une d√©tection rapide)
(sudo crontab -l 2>/dev/null | grep -v "detect-malware"; echo "*/1 * * * * /usr/local/bin/detect-malware.sh") | sudo crontab -
echo "   ‚úÖ Script de monitoring install√© (v√©rifie toutes les 1 minute)"
echo ""

# 13. PROTECTION DES FICHIERS CRITIQUES
echo "13Ô∏è‚É£ Protection des fichiers critiques..."
# Rendre les fichiers de profil en lecture seule (sauf pour root)
sudo chmod 644 ~/.bashrc ~/.profile 2>/dev/null || true
echo "   ‚úÖ Fichiers prot√©g√©s"
echo ""

# 14. INSTALLER/METTRE √Ä JOUR Fail2Ban
echo "14Ô∏è‚É£ V√©rification Fail2Ban..."
if ! command -v fail2ban-client &> /dev/null; then
    echo "   Installation de Fail2Ban..."
    sudo apt-get update -qq
    sudo apt-get install -y fail2ban
    sudo systemctl enable fail2ban
    sudo systemctl start fail2ban
    echo "   ‚úÖ Fail2Ban install√©"
else
    echo "   ‚úÖ Fail2Ban d√©j√† install√©"
    sudo systemctl restart fail2ban 2>/dev/null || true
fi
echo ""

# 15. V√âRIFICATION FINALE
echo "=== V√âRIFICATION FINALE ==="
echo ""
echo "Processus:"
ps aux | grep -E "xmrig|monero" | grep -v grep || echo "‚úÖ Aucun processus"
echo ""
echo "Crontabs:"
sudo crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "‚úÖ Crontab root propre"
crontab -l 2>/dev/null | grep -E "xmrig|monero|curl.*sh|wget.*sh" || echo "‚úÖ Crontab user propre"
echo ""
echo "Services:"
sudo systemctl list-units --all 2>/dev/null | grep -E "monero|xmrig" || echo "‚úÖ Aucun service"
echo ""
echo "R√©pertoires:"
[ -d ~/moneroocean ] && echo "‚ùå ~/moneroocean existe encore" || echo "‚úÖ ~/moneroocean supprim√©"
[ -d /root/moneroocean ] && echo "‚ùå /root/moneroocean existe encore" || echo "‚úÖ /root/moneroocean supprim√©"
echo ""
echo "Monitoring:"
[ -f /usr/local/bin/detect-malware.sh ] && echo "‚úÖ Script de monitoring install√©" || echo "‚ùå Script non install√©"
sudo crontab -l 2>/dev/null | grep -q "detect-malware" && echo "‚úÖ Monitoring actif dans crontab" || echo "‚ùå Monitoring non actif"
echo ""

echo "=== NETTOYAGE TERMIN√â ==="
echo ""
echo "üìã Actions URGENTES recommand√©es:"
echo "   1. Changez TOUS les mots de passe (SSH, root, utilisateurs)"
echo "   2. V√©rifiez les cl√©s SSH: cat ~/.ssh/authorized_keys"
echo "   3. Limitez l'acc√®s SSH: sudo ufw allow from VOTRE_IP to any port 22"
echo "   4. D√©sactivez l'authentification root par SSH:"
echo "      sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config"
echo "      sudo systemctl restart sshd"
echo "   5. Surveillez les logs: sudo tail -f /var/log/malware-detection.log"
echo "   6. V√©rifiez les permissions: ls -la ~"
echo ""
echo "üîí Le malware sera automatiquement supprim√© s'il revient (v√©rification toutes les 1 minute)"
echo "üìä Les sauvegardes des crontabs sont dans: $BACKUP_DIR"
