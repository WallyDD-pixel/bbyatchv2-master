#!/bin/bash

# Script pour v√©rifier comment le malware persiste et se r√©installe
# Usage: bash deploy/verifier-persistence-malware.sh

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "=========================================="
echo "üîç V√âRIFICATION DE LA PERSISTANCE DU MALWARE"
echo "=========================================="
echo ""

# 1. V√©rifier les crontabs de tous les utilisateurs
echo -e "${YELLOW}[1/10] V√©rification des crontabs...${NC}"
echo "Crontab de l'utilisateur actuel:"
crontab -l 2>/dev/null || echo "Aucun crontab pour cet utilisateur"
echo ""

echo "Crontabs syst√®me:"
sudo crontab -l 2>/dev/null || echo "Aucun crontab root"
echo ""

echo "Crontabs dans /etc/cron.*:"
for dir in /etc/cron.d /etc/cron.daily /etc/cron.hourly /etc/cron.weekly /etc/cron.monthly; do
    if [ -d "$dir" ]; then
        echo "--- $dir ---"
        ls -lah "$dir" 2>/dev/null | grep -v "^total\|^d" || echo "Vide"
        echo ""
    fi
done

# 2. V√©rifier les systemd timers
echo -e "${YELLOW}[2/10] V√©rification des systemd timers...${NC}"
systemctl list-timers --all 2>/dev/null | head -20
echo ""

# 3. V√©rifier les services systemd suspects
echo -e "${YELLOW}[3/10] V√©rification des services systemd suspects...${NC}"
systemctl list-units --type=service --all | grep -E "cUpXNEP1|\.sh|tmp|suspicious" || echo "Aucun service suspect trouv√©"
echo ""

# 4. V√©rifier les fichiers dans /tmp avec des noms suspects
echo -e "${YELLOW}[4/10] Recherche de fichiers suspects dans /tmp...${NC}"
find /tmp -type f -executable -name "[a-zA-Z0-9]{8,}" 2>/dev/null | head -20
echo ""

# 5. V√©rifier les fichiers dans le home directory
echo -e "${YELLOW}[5/10] Recherche de fichiers suspects dans ~...${NC}"
find ~ -type f -executable -name "[a-zA-Z0-9]{8,}" 2>/dev/null | head -20
echo ""

# 6. V√©rifier les fichiers .bashrc, .bash_profile, .profile
echo -e "${YELLOW}[6/10] V√©rification des fichiers de profil shell...${NC}"
for file in ~/.bashrc ~/.bash_profile ~/.profile ~/.bash_logout; do
    if [ -f "$file" ]; then
        echo "--- $file ---"
        grep -E "cUpXNEP1|base64|curl.*sh|wget.*sh|/tmp/" "$file" || echo "Rien de suspect"
        echo ""
    fi
done

# 7. V√©rifier les processus en cours avec des noms suspects
echo -e "${YELLOW}[7/10] V√©rification des processus en cours...${NC}"
ps aux | grep -E "cUpXNEP1|\./[a-zA-Z0-9]{8,}" | grep -v grep || echo "Aucun processus suspect"
echo ""

# 8. V√©rifier les connexions r√©seau suspectes
echo -e "${YELLOW}[8/10] V√©rification des connexions r√©seau...${NC}"
netstat -tunap 2>/dev/null | grep -E "ESTABLISHED|LISTEN" | head -20
echo ""

# 9. V√©rifier les fichiers r√©cemment modifi√©s dans /tmp
echo -e "${YELLOW}[9/10] Fichiers r√©cemment modifi√©s dans /tmp...${NC}"
find /tmp -type f -mtime -7 -ls 2>/dev/null | head -20
echo ""

# 10. V√©rifier les logs syst√®me pour voir comment le malware a √©t√© install√©
echo -e "${YELLOW}[10/10] Recherche dans les logs syst√®me...${NC}"
echo "Recherche de 'cUpXNEP1' dans les logs:"
sudo journalctl -u cron* --since "7 days ago" 2>/dev/null | grep -i "cUpXNEP1" | tail -20 || echo "Aucune trace dans les logs cron"
echo ""

echo "Recherche de commandes suspectes dans les logs:"
sudo journalctl --since "7 days ago" 2>/dev/null | grep -E "base64.*sh|curl.*sh|wget.*sh|/tmp/.*sh" | tail -20 || echo "Aucune commande suspecte trouv√©e"
echo ""

echo "=========================================="
echo "üìã R√âSUM√â ET RECOMMANDATIONS"
echo "=========================================="
echo ""
echo "Points √† v√©rifier manuellement:"
echo "  1. V√©rifier les crontabs list√©s ci-dessus"
echo "  2. V√©rifier les systemd timers actifs"
echo "  3. Surveiller /tmp pour de nouveaux fichiers suspects"
echo "  4. V√©rifier les fichiers de profil shell modifi√©s"
echo ""
echo "Protection recommand√©e:"
echo "  - D√©sactiver l'ex√©cution depuis /tmp: mount /tmp avec noexec"
echo "  - Surveiller les processus avec: watch -n 5 'ps aux --sort=-%cpu | head -10'"
echo "  - Installer un IDS/IPS comme fail2ban (d√©j√† install√©)"
echo ""

