#!/bin/bash

echo "üîí Nettoyage complet du malware MoneroOcean"
echo "=========================================="
echo ""

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. Arr√™ter tous les processus malveillants
echo -e "${YELLOW}1Ô∏è‚É£ Arr√™t des processus malveillants...${NC}"
PROCESSES_KILLED=0

# Liste des processus √† tuer
MALWARE_PATTERNS=("xmrig" "moneroocean" "miner" "crypto" "mining")

for pattern in "${MALWARE_PATTERNS[@]}"; do
    PIDS=$(pgrep -f "$pattern" 2>/dev/null || true)
    if [ -n "$PIDS" ]; then
        echo -e "   ${RED}‚ö†Ô∏è  Processus '$pattern' d√©tect√© (PIDs: $PIDS)${NC}"
        pkill -9 -f "$pattern" 2>/dev/null || true
        PROCESSES_KILLED=$((PROCESSES_KILLED + 1))
        sleep 1
    fi
done

if [ $PROCESSES_KILLED -eq 0 ]; then
    echo -e "   ${GREEN}‚úÖ Aucun processus malveillant d√©tect√©${NC}"
else
    echo -e "   ${GREEN}‚úÖ $PROCESSES_KILLED type(s) de processus arr√™t√©(s)${NC}"
fi

# 2. Supprimer le dossier moneroocean et autres dossiers suspects
echo ""
echo -e "${YELLOW}2Ô∏è‚É£ Suppression des dossiers malveillants...${NC}"
SUSPECT_DIRS=(
    "$HOME/moneroocean"
    "$HOME/xmrig"
    "$HOME/miner"
    "/tmp/moneroocean"
    "/tmp/xmrig"
    "/var/tmp/moneroocean"
    "/var/tmp/xmrig"
    "/var/tmp/systemd-logind"
    "/opt/moneroocean"
    "/opt/xmrig"
)

DIRS_REMOVED=0
for dir in "${SUSPECT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "   ${RED}‚ö†Ô∏è  Dossier suspect trouv√©: $dir${NC}"
        if [ -w "$(dirname "$dir")" ] || [ "$(dirname "$dir")" = "/tmp" ] || [ "$(dirname "$dir")" = "/var/tmp" ]; then
            rm -rf "$dir" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Supprim√©${NC}" || sudo rm -rf "$dir" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Supprim√© (sudo)${NC}"
            DIRS_REMOVED=$((DIRS_REMOVED + 1))
        else
            echo -e "   ${YELLOW}‚ö†Ô∏è  N√©cessite sudo pour supprimer${NC}"
            sudo rm -rf "$dir" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Supprim√©${NC}" || echo -e "   ${RED}‚ùå √âchec de la suppression${NC}"
        fi
    fi
done

if [ $DIRS_REMOVED -eq 0 ]; then
    echo -e "   ${GREEN}‚úÖ Aucun dossier suspect trouv√©${NC}"
fi

# 3. Nettoyer les crontabs
echo ""
echo -e "${YELLOW}3Ô∏è‚É£ Nettoyage des crontabs...${NC}"
CRON_CLEANED=0

# Crontab utilisateur
if crontab -l 2>/dev/null | grep -qE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|\.sh.*http)"; then
    echo -e "   ${RED}‚ö†Ô∏è  Crontab utilisateur suspect d√©tect√© !${NC}"
    crontab -l 2>/dev/null | grep -E "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|\.sh.*http)" | sed 's/^/      /'
    crontab -l 2>/dev/null | grep -vE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh|\.sh.*http)" | crontab -
    echo -e "   ${GREEN}‚úÖ Crontab utilisateur nettoy√©${NC}"
    CRON_CLEANED=1
else
    echo -e "   ${GREEN}‚úÖ Crontab utilisateur propre${NC}"
fi

# Crontab syst√®me
if [ -f /etc/crontab ] && sudo grep -qE "(xmrig|moneroocean|miner)" /etc/crontab 2>/dev/null; then
    echo -e "   ${RED}‚ö†Ô∏è  Crontab syst√®me suspect dans /etc/crontab !${NC}"
    echo -e "   ${YELLOW}‚ö†Ô∏è  ACTION REQUISE: V√©rifiez manuellement /etc/crontab${NC}"
    CRON_CLEANED=1
fi

# Crontabs dans /etc/cron.d
if [ -d /etc/cron.d ]; then
    for cron_file in /etc/cron.d/*; do
        if [ -f "$cron_file" ] && sudo grep -qE "(xmrig|moneroocean|miner)" "$cron_file" 2>/dev/null; then
            echo -e "   ${RED}‚ö†Ô∏è  Crontab suspect dans: $cron_file${NC}"
            echo -e "   ${YELLOW}‚ö†Ô∏è  ACTION REQUISE: V√©rifiez manuellement ce fichier${NC}"
            CRON_CLEANED=1
        fi
    done
fi

# 4. V√©rifier et supprimer les services systemd
echo ""
echo -e "${YELLOW}4Ô∏è‚É£ V√©rification des services systemd...${NC}"
SERVICES_FOUND=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" || true)
if [ -n "$SERVICES_FOUND" ]; then
    echo -e "   ${RED}‚ö†Ô∏è  Service suspect d√©tect√© !${NC}"
    echo "$SERVICES_FOUND" | sed 's/^/      /'
    echo ""
    echo "   Arr√™t et d√©sactivation des services..."
    for service in $(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" | awk '{print $1}'); do
        echo "   Arr√™t de: $service"
        sudo systemctl stop "$service" 2>/dev/null || true
        sudo systemctl disable "$service" 2>/dev/null || true
        sudo rm -f "/etc/systemd/system/$service" 2>/dev/null || true
        sudo rm -f "/etc/systemd/system/$service.service" 2>/dev/null || true
        sudo rm -f "/usr/lib/systemd/system/$service" 2>/dev/null || true
        sudo rm -f "/usr/lib/systemd/system/$service.service" 2>/dev/null || true
    done
    sudo systemctl daemon-reload 2>/dev/null || true
    echo -e "   ${GREEN}‚úÖ Services arr√™t√©s et d√©sactiv√©s${NC}"
else
    echo -e "   ${GREEN}‚úÖ Aucun service suspect${NC}"
fi

# 5. V√©rifier et nettoyer les fichiers de d√©marrage automatique (.bashrc backdoor)
echo ""
echo -e "${YELLOW}5Ô∏è‚É£ V√©rification des fichiers de d√©marrage...${NC}"
STARTUP_FILES=(
    "/etc/rc.local"
    "/etc/init.d/xmrig"
    "/etc/init.d/moneroocean"
    "$HOME/.bashrc"
    "$HOME/.bash_profile"
    "$HOME/.profile"
    "/etc/profile"
    "$HOME/.zshrc"
    "$HOME/.zprofile"
)

# Patterns de backdoor (dont: /var/tmp + systemd-logind lanc√© depuis .bashrc)
BACKDOOR_GREP="xmrig|moneroocean|miner|/var/tmp.*nohup.*systemd-logind|cd /var/tmp && nohup"

STARTUP_FOUND=0
for file in "${STARTUP_FILES[@]}"; do
    if [ -f "$file" ]; then
        if grep -qE "($BACKDOOR_GREP)" "$file" 2>/dev/null; then
            echo -e "   ${RED}‚ö†Ô∏è  Contenu suspect dans: $file${NC}"
            grep -nE "($BACKDOOR_GREP)" "$file" 2>/dev/null | sed 's/^/      /'
            if [ -w "$file" ]; then
                grep -vE "($BACKDOOR_GREP)" "$file" > "${file}.bak" && mv "${file}.bak" "$file" && echo -e "   ${GREEN}‚úÖ Ligne(s) suspecte(s) supprim√©e(s)${NC}" && STARTUP_FOUND=1
            else
                echo -e "   ${YELLOW}‚ö†Ô∏è  Fichier en lecture seule, supprimez manuellement les lignes ci-dessus${NC}"
                STARTUP_FOUND=1
            fi
        fi
    fi
done

if [ $STARTUP_FOUND -eq 0 ]; then
    echo -e "   ${GREEN}‚úÖ Aucun fichier de d√©marrage suspect${NC}"
fi

# 6. Rechercher et supprimer les fichiers suspects
echo ""
echo -e "${YELLOW}6Ô∏è‚É£ Recherche de fichiers suspects...${NC}"

# Liste compl√®te des fichiers malveillants connus √† supprimer
MALWARE_FILES=(
    "$HOME/xmrig*"
    "$HOME/xmrig-6.21.0"
    "$HOME/xmrig.tar.gz"
    "$HOME/miner*"
    "$HOME/monitor.log"
    "$HOME/exploited.log"
    "$HOME/failed.log"
    "$HOME/scanner_deployed.log"
    "$HOME/scanner_linux"
    "$HOME/systemwatcher"
    "/tmp/xmrig*"
    "/tmp/miner*"
    "/tmp/scanner_linux"
    "/tmp/systemwatcher"
    "/var/tmp/xmrig*"
    "/var/tmp/miner*"
    "/var/tmp/scanner_linux"
    "/var/tmp/systemwatcher"
    "/var/tmp/systemd-logind"
    "/var/tmp/config.json"
)

FILES_REMOVED=0

# Supprimer les fichiers sp√©cifiques
for pattern in "${MALWARE_FILES[@]}"; do
    for file in $pattern; do
        if [ -e "$file" ] && [ "$file" != "$0" ]; then
            echo -e "   ${RED}‚ö†Ô∏è  Fichier malveillant trouv√©: $file${NC}"
            if [ -d "$file" ]; then
                rm -rf "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Dossier supprim√©${NC}" || sudo rm -rf "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Dossier supprim√© (sudo)${NC}"
            else
                rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Fichier supprim√©${NC}" || sudo rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Fichier supprim√© (sudo)${NC}"
            fi
            FILES_REMOVED=$((FILES_REMOVED + 1))
        fi
    done
done

# Recherche r√©cursive dans le projet (limit√© √† 3 niveaux)
echo "   Recherche dans le projet actuel..."
CURRENT_DIR=$(pwd)
find "$CURRENT_DIR" -maxdepth 3 -type f \( -name "*xmrig*" -o -name "*miner*" -o -name "*moneroocean*" -o -name "scanner_linux" -o -name "systemwatcher" -o -name "monitor.log" -o -name "exploited.log" -o -name "failed.log" -o -name "scanner_deployed.log" \) ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/.next/*" 2>/dev/null | while read file; do
    if [ "$file" != "$0" ] && [ "$file" != "./cleanup-malware-complete.sh" ] && [ "$file" != "./monitor-malware.sh" ] && [ "$file" != "./harden-security.sh" ] && [ "$file" != "./install-protection.sh" ]; then
        echo -e "   ${RED}‚ö†Ô∏è  Fichier suspect trouv√©: $file${NC}"
        rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Supprim√©${NC}" || echo -e "   ${YELLOW}‚ö†Ô∏è  Impossible de supprimer${NC}"
        FILES_REMOVED=$((FILES_REMOVED + 1))
    fi
done

# Recherche dans le home (limit√© √† 2 niveaux)
echo "   Recherche dans $HOME (max 2 niveaux)..."
find "$HOME" -maxdepth 2 -type f \( -name "*xmrig*" -o -name "*miner*" -o -name "*moneroocean*" -o -name "scanner_linux" -o -name "systemwatcher" \) 2>/dev/null | while read file; do
    if [ "$file" != "$0" ]; then
        echo -e "   ${RED}‚ö†Ô∏è  Fichier suspect trouv√©: $file${NC}"
        rm -f "$file" 2>/dev/null && echo -e "   ${GREEN}‚úÖ Supprim√©${NC}" || echo -e "   ${YELLOW}‚ö†Ô∏è  Impossible de supprimer${NC}"
        FILES_REMOVED=$((FILES_REMOVED + 1))
    fi
done

if [ $FILES_REMOVED -eq 0 ]; then
    echo -e "   ${GREEN}‚úÖ Aucun fichier suspect trouv√©${NC}"
fi

# 7. V√©rifier les processus en cours apr√®s nettoyage
echo ""
echo -e "${YELLOW}7Ô∏è‚É£ V√©rification finale des processus...${NC}"
REMAINING=$(ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep || true)
if [ -n "$REMAINING" ]; then
    echo -e "   ${RED}‚ö†Ô∏è  Processus suspects encore en cours:${NC}"
    echo "$REMAINING" | sed 's/^/      /'
    echo ""
    echo "   Tentative d'arr√™t forc√©..."
    pkill -9 -f xmrig 2>/dev/null || true
    pkill -9 -f moneroocean 2>/dev/null || true
    pkill -9 -f miner 2>/dev/null || true
    sleep 2
    REMAINING_AFTER=$(ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep || true)
    if [ -n "$REMAINING_AFTER" ]; then
        echo -e "   ${RED}‚ùå Certains processus persistent encore !${NC}"
        echo -e "   ${YELLOW}‚ö†Ô∏è  ACTION REQUISE: Arr√™tez-les manuellement${NC}"
    else
        echo -e "   ${GREEN}‚úÖ Tous les processus arr√™t√©s${NC}"
    fi
else
    echo -e "   ${GREEN}‚úÖ Aucun processus suspect${NC}"
fi

# 8. V√©rifier la m√©moire
echo ""
echo -e "${YELLOW}8Ô∏è‚É£ √âtat de la m√©moire...${NC}"
free -h | sed 's/^/   /'

# 9. R√©sum√© et recommandations
echo ""
echo "=========================================="
echo -e "${GREEN}‚úÖ Nettoyage termin√© !${NC}"
echo ""
echo -e "${YELLOW}üìã Actions recommand√©es:${NC}"
echo "   1. V√©rifiez manuellement: crontab -l"
echo "   2. V√©rifiez: sudo cat /etc/crontab"
echo "   3. V√©rifiez: sudo systemctl list-units --type=service | grep -E '(xmrig|miner)'"
echo "   4. Surveillez les processus: ps aux | grep -E '(xmrig|miner|moneroocean)'"
echo "   5. Changez tous les mots de passe (SSH, utilisateur, etc.)"
echo "   6. Mettez √† jour le syst√®me: sudo apt update && sudo apt upgrade -y"
echo "   7. V√©rifiez les logs: sudo journalctl -xe | grep -E '(xmrig|miner|moneroocean)'"
echo "   8. V√©rifiez les connexions SSH: sudo lastlog"
echo "   9. V√©rifiez les cl√©s SSH autoris√©es: cat ~/.ssh/authorized_keys"
echo ""
echo -e "${YELLOW}üîí Pour emp√™cher la r√©infection:${NC}"
echo "   - D√©sactivez l'authentification par cl√© SSH si non n√©cessaire"
echo "   - Utilisez des mots de passe forts"
echo "   - Limitez l'acc√®s SSH avec UFW: sudo ufw allow from YOUR_IP to any port 22"
echo "   - D√©sactivez l'authentification root: sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config"
echo "   - Surveillez r√©guli√®rement les processus et la m√©moire"
echo "   - Installez fail2ban: sudo apt install fail2ban -y"
echo ""
echo -e "${YELLOW}üîç Surveillance continue:${NC}"
echo "   - Surveillez la m√©moire: watch -n 5 free -h"
echo "   - Surveillez les processus: watch -n 5 'ps aux | grep -E \"(xmrig|miner|moneroocean)\"'"
echo "   - V√©rifiez les crontabs r√©guli√®rement: crontab -l"
echo ""
