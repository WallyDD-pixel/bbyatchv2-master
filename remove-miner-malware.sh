#!/bin/bash

echo "üîí Suppression du malware de minage (xmrig/moneroocean)"
echo "=================================================="
echo ""

# 1. Arr√™ter tous les processus xmrig/miner
echo "1Ô∏è‚É£ Arr√™t des processus malveillants..."
if pgrep -f xmrig > /dev/null; then
    echo "   ‚ö†Ô∏è  Processus xmrig d√©tect√©, arr√™t en cours..."
    pkill -9 -f xmrig
    pkill -9 -f moneroocean
    pkill -9 -f miner
    sleep 2
    if pgrep -f xmrig > /dev/null; then
        echo "   ‚ùå Impossible d'arr√™ter xmrig, v√©rifiez manuellement"
    else
        echo "   ‚úÖ Processus arr√™t√©s"
    fi
else
    echo "   ‚úÖ Aucun processus xmrig en cours"
fi

# 2. Supprimer le dossier moneroocean
echo ""
echo "2Ô∏è‚É£ Suppression du dossier moneroocean..."
if [ -d ~/moneroocean ]; then
    echo "   ‚ö†Ô∏è  Dossier moneroocean trouv√©, suppression..."
    rm -rf ~/moneroocean
    echo "   ‚úÖ Dossier supprim√©"
else
    echo "   ‚úÖ Dossier moneroocean non trouv√©"
fi

# V√©rifier aussi dans d'autres emplacements
for dir in /tmp/moneroocean /var/tmp/moneroocean /opt/moneroocean; do
    if [ -d "$dir" ]; then
        echo "   ‚ö†Ô∏è  Dossier trouv√© dans $dir, suppression..."
        sudo rm -rf "$dir"
        echo "   ‚úÖ Supprim√©"
    fi
done

# 3. V√©rifier et nettoyer les cron jobs
echo ""
echo "3Ô∏è‚É£ V√©rification des cron jobs..."
CRON_SUSPECT=$(crontab -l 2>/dev/null | grep -E "(xmrig|moneroocean|miner|wget.*sh|curl.*sh)" || true)
if [ -n "$CRON_SUSPECT" ]; then
    echo "   ‚ö†Ô∏è  Cron job suspect d√©tect√© !"
    echo "   Contenu suspect:"
    echo "$CRON_SUSPECT" | sed 's/^/      /'
    echo ""
    echo "   Suppression des cron jobs suspects..."
    crontab -l 2>/dev/null | grep -vE "(xmrig|moneroocean|miner|wget.*sh|curl.*sh)" | crontab -
    echo "   ‚úÖ Cron jobs suspects supprim√©s"
else
    echo "   ‚úÖ Aucun cron job suspect"
fi

# V√©rifier aussi les cron jobs syst√®me
echo ""
echo "   V√©rification des cron jobs syst√®me..."
if [ -f /etc/crontab ]; then
    if grep -qE "(xmrig|moneroocean|miner)" /etc/crontab 2>/dev/null; then
        echo "   ‚ö†Ô∏è  Cron job suspect dans /etc/crontab !"
        echo "   ‚ö†Ô∏è  ACTION REQUISE: V√©rifiez manuellement /etc/crontab"
    fi
fi

# 4. V√©rifier et supprimer les services systemd
echo ""
echo "4Ô∏è‚É£ V√©rification des services systemd..."
SERVICES=$(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" || true)
if [ -n "$SERVICES" ]; then
    echo "   ‚ö†Ô∏è  Service suspect d√©tect√© !"
    echo "$SERVICES" | sed 's/^/      /'
    echo ""
    echo "   Arr√™t et d√©sactivation des services..."
    for service in $(systemctl list-units --type=service --all 2>/dev/null | grep -E "(xmrig|moneroocean|miner)" | awk '{print $1}'); do
        echo "   Arr√™t de: $service"
        sudo systemctl stop "$service" 2>/dev/null || true
        sudo systemctl disable "$service" 2>/dev/null || true
    done
    echo "   ‚úÖ Services arr√™t√©s et d√©sactiv√©s"
else
    echo "   ‚úÖ Aucun service suspect"
fi

# 5. V√©rifier les fichiers de d√©marrage automatique
echo ""
echo "5Ô∏è‚É£ V√©rification des fichiers de d√©marrage..."
STARTUP_FILES=(
    "/etc/rc.local"
    "/etc/init.d/xmrig"
    "/etc/init.d/moneroocean"
    "~/.bashrc"
    "~/.bash_profile"
    "~/.profile"
    "/etc/profile"
)

for file in "${STARTUP_FILES[@]}"; do
    if [ -f "$file" ]; then
        if grep -qE "(xmrig|moneroocean|miner)" "$file" 2>/dev/null; then
            echo "   ‚ö†Ô∏è  Contenu suspect dans: $file"
            echo "   ‚ö†Ô∏è  ACTION REQUISE: V√©rifiez manuellement ce fichier"
        fi
    fi
done

# 6. V√©rifier les processus en cours
echo ""
echo "6Ô∏è‚É£ V√©rification des processus en cours..."
PROCESSES=$(ps aux | grep -E "(xmrig|moneroocean|miner)" | grep -v grep || true)
if [ -n "$PROCESSES" ]; then
    echo "   ‚ö†Ô∏è  Processus suspects encore en cours:"
    echo "$PROCESSES" | sed 's/^/      /'
    echo ""
    echo "   Tentative d'arr√™t forc√©..."
    pkill -9 -f xmrig
    pkill -9 -f moneroocean
    pkill -9 -f miner
else
    echo "   ‚úÖ Aucun processus suspect"
fi

# 7. V√©rifier les fichiers suspects dans le home
echo ""
echo "7Ô∏è‚É£ Recherche de fichiers suspects dans ~..."
find ~ -maxdepth 2 -type f -name "*xmrig*" -o -name "*miner*" -o -name "*moneroocean*" 2>/dev/null | while read file; do
    echo "   ‚ö†Ô∏è  Fichier suspect trouv√©: $file"
    read -p "   Supprimer ? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "$file"
        echo "   ‚úÖ Supprim√©"
    fi
done

# 8. V√©rifier les permissions et la s√©curit√©
echo ""
echo "8Ô∏è‚É£ V√©rification de la s√©curit√©..."
echo "   V√©rification des permissions du dossier home..."
if [ -w ~ ]; then
    echo "   ‚úÖ Permissions OK"
else
    echo "   ‚ö†Ô∏è  Dossier home non accessible en √©criture"
fi

# 9. R√©sum√©
echo ""
echo "=================================================="
echo "‚úÖ Nettoyage termin√© !"
echo ""
echo "üìã Actions recommand√©es:"
echo "   1. V√©rifiez manuellement: crontab -l"
echo "   2. V√©rifiez: /etc/crontab"
echo "   3. V√©rifiez: systemctl list-units --type=service | grep -E '(xmrig|miner)'"
echo "   4. Surveillez les processus: ps aux | grep -E '(xmrig|miner)'"
echo "   5. Changez tous les mots de passe"
echo "   6. Mettez √† jour le syst√®me: sudo apt update && sudo apt upgrade"
echo "   7. V√©rifiez les logs: journalctl -xe | grep -E '(xmrig|miner)'"
echo ""
echo "üîí Pour emp√™cher la r√©infection:"
echo "   - D√©sactivez l'authentification par cl√© SSH si non n√©cessaire"
echo "   - Utilisez des mots de passe forts"
echo "   - Limitez l'acc√®s SSH avec UFW"
echo "   - Surveillez r√©guli√®rement les processus"
echo ""
