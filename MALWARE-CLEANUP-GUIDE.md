# Guide de Nettoyage du Malware MoneroOcean

## üö® Situation Actuelle

Le malware MoneroOcean (mineur de cryptomonnaie) est revenu sur votre serveur. Il consomme vos ressources CPU et m√©moire.

## ‚ö° Actions Imm√©diates

### 1. T√©l√©charger les scripts de nettoyage

Sur votre serveur, ex√©cutez :

```bash
cd ~/bbyatchv2-master
```

### 2. Ex√©cuter le nettoyage complet

```bash
chmod +x cleanup-malware-complete.sh
bash cleanup-malware-complete.sh
```

Ce script va :
- ‚úÖ Arr√™ter tous les processus malveillants
- ‚úÖ Supprimer le dossier `moneroocean` et autres dossiers suspects
- ‚úÖ Nettoyer les crontabs malveillants
- ‚úÖ D√©sactiver les services systemd suspects
- ‚úÖ V√©rifier les fichiers de d√©marrage automatique
- ‚úÖ Supprimer les fichiers suspects

### 3. V√©rifier que le nettoyage a fonctionn√©

```bash
chmod +x monitor-malware.sh
bash monitor-malware.sh
```

## üõ°Ô∏è Protection Permanente (RECOMMAND√â)

### Installation automatique de toutes les protections

Pour installer **automatiquement toutes les protections** et emp√™cher le malware de revenir :

```bash
cd ~/bbyatchv2-master
chmod +x install-protection.sh
bash install-protection.sh
```

Ce script va :
- ‚úÖ Nettoyer le malware existant
- ‚úÖ Configurer le pare-feu UFW (limite SSH √† votre IP)
- ‚úÖ Installer et configurer fail2ban
- ‚úÖ S√©curiser SSH (d√©sactive root, limite les tentatives)
- ‚úÖ Cr√©er un service de protection automatique (v√©rifie toutes les 5 minutes)
- ‚úÖ Configurer un monitoring quotidien
- ‚úÖ Configurer les limites de ressources

### Protection automatique install√©e

Une fois install√©, le syst√®me :
- üîÑ **V√©rifie automatiquement toutes les 5 minutes** la pr√©sence de malware
- üõë **Arr√™te et supprime automatiquement** tout malware d√©tect√©
- üìù **Enregistre toutes les d√©tections** dans `/var/log/malware-protection.log`

### V√©rifier le statut de la protection

```bash
# V√©rifier que le service de protection est actif
sudo systemctl status malware-protection.timer

# Voir les logs de protection
sudo tail -f /var/log/malware-protection.log

# V√©rifier fail2ban
sudo fail2ban-client status

# V√©rifier le pare-feu
sudo ufw status
```

## üîí Pr√©vention de la R√©infection (M√©thode Manuelle)

### 1. Changer tous les mots de passe

```bash
# Changer le mot de passe de l'utilisateur actuel
passwd

# V√©rifier les autres utilisateurs
cat /etc/passwd | grep /bin/bash
```

### 2. S√©curiser SSH

```bash
# V√©rifier les cl√©s SSH autoris√©es
cat ~/.ssh/authorized_keys

# Si vous voyez des cl√©s suspectes, supprimez-les
nano ~/.ssh/authorized_keys

# D√©sactiver l'authentification root (si vous n'en avez pas besoin)
sudo nano /etc/ssh/sshd_config
# Changez: PermitRootLogin no
sudo systemctl restart sshd
```

### 3. Configurer le pare-feu (UFW)

```bash
# Installer UFW si pas d√©j√† install√©
sudo apt install ufw -y

# Autoriser uniquement votre IP pour SSH
sudo ufw allow from VOTRE_IP to any port 22

# Autoriser HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Activer le pare-feu
sudo ufw enable
```

### 4. Installer fail2ban

```bash
sudo apt install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 5. Mettre √† jour le syst√®me

```bash
sudo apt update
sudo apt upgrade -y
```

## üîç Surveillance Continue

### Surveillance manuelle

Ex√©cutez r√©guli√®rement :

```bash
bash monitor-malware.sh
```

### Surveillance automatique avec cron

Ajoutez une v√©rification quotidienne (√† 3h du matin) :

```bash
crontab -e
```

Ajoutez cette ligne :

```
0 3 * * * /home/ec2-user/bbyatchv2-master/monitor-malware.sh >> /home/ec2-user/malware-monitor.log 2>&1
```

### Commandes de surveillance rapide

```bash
# V√©rifier les processus suspects
ps aux | grep -E "(xmrig|moneroocean|miner)"

# V√©rifier la m√©moire
free -h

# V√©rifier les crontabs
crontab -l

# V√©rifier les services
systemctl list-units --type=service | grep -E "(xmrig|miner)"

# V√©rifier les connexions SSH r√©centes
sudo lastlog
```

## üÜò Si le Malware Revient

1. **Ex√©cutez imm√©diatement le nettoyage** :
   ```bash
   bash cleanup-malware-complete.sh
   ```

2. **Identifiez la source de l'infection** :
   - V√©rifiez les logs SSH : `sudo journalctl -u ssh | tail -50`
   - V√©rifiez les connexions : `sudo lastlog`
   - V√©rifiez les cl√©s SSH : `cat ~/.ssh/authorized_keys`

3. **Changez imm√©diatement** :
   - Tous les mots de passe
   - Les cl√©s SSH autoris√©es
   - Les credentials d'acc√®s

4. **Renforcez la s√©curit√©** :
   - Limitez l'acc√®s SSH √† votre IP uniquement
   - D√©sactivez l'authentification par mot de passe si possible
   - Utilisez uniquement des cl√©s SSH

## üìä Indicateurs de Malware

Signes que le malware est actif :
- ‚ö†Ô∏è M√©moire utilis√©e > 90%
- ‚ö†Ô∏è Processus `xmrig`, `moneroocean`, ou `miner` en cours
- ‚ö†Ô∏è Dossier `~/moneroocean` pr√©sent
- ‚ö†Ô∏è Crontabs suspects
- ‚ö†Ô∏è Services systemd suspects
- ‚ö†Ô∏è CPU utilis√© √† 100% sans raison apparente

## üõ°Ô∏è Syst√®me de Protection Automatique

### Comment √ßa fonctionne

Le script `harden-security.sh` installe un **service systemd** qui :

1. **S'ex√©cute automatiquement toutes les 5 minutes**
2. **D√©tecte** les processus, dossiers et crontabs malveillants
3. **Supprime automatiquement** toute menace d√©tect√©e
4. **Enregistre** toutes les actions dans les logs

### Fichiers cr√©√©s

- `/usr/local/bin/malware-protection.sh` - Script de protection
- `/etc/systemd/system/malware-protection.service` - Service systemd
- `/etc/systemd/system/malware-protection.timer` - Timer (toutes les 5 min)
- `/var/log/malware-protection.log` - Logs de protection

### Commandes de gestion

```bash
# Voir le statut du service
sudo systemctl status malware-protection.timer

# Voir les logs en temps r√©el
sudo tail -f /var/log/malware-protection.log

# Red√©marrer le service
sudo systemctl restart malware-protection.timer

# D√©sactiver (si n√©cessaire)
sudo systemctl stop malware-protection.timer
sudo systemctl disable malware-protection.timer
```

## üìù Notes

- ‚úÖ **Avec le syst√®me de protection automatique**, le malware sera d√©tect√© et supprim√© automatiquement
- ‚úÖ Le syst√®me v√©rifie **toutes les 5 minutes** sans intervention
- ‚úÖ Toutes les d√©tections sont **enregistr√©es dans les logs**
- ‚ö†Ô∏è Si le probl√®me persiste malgr√© les protections, v√©rifiez :
  - Les cl√©s SSH autoris√©es
  - Les autres utilisateurs sur le syst√®me
  - Les applications tierces qui pourraient √™tre compromises
  - Consid√©rez recr√©er l'instance EC2 avec une configuration s√©curis√©e d√®s le d√©part
