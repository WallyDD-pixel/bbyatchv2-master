#!/bin/bash

echo "ðŸ” Scan approfondi pour trouver la redirection malveillante..."

cd ~/bbyatchv2 || exit 1

# 1. VÃ©rifier nginx encore une fois
echo "1ï¸âƒ£ VÃ©rification nginx (tous les fichiers):"
find /etc/nginx -type f -name "*.conf" -o -name "*bbyatch*" 2>/dev/null | while read file; do
    if grep -q "claim-reward.solgalaxy.cc" "$file" 2>/dev/null; then
        echo "   âš ï¸  TROUVÃ‰ dans: $file"
    fi
done

# 2. VÃ©rifier les fichiers dans .next (build)
echo ""
echo "2ï¸âƒ£ VÃ©rification du build .next..."
if [ -d .next ]; then
    find .next -type f \( -name "*.html" -o -name "*.js" \) 2>/dev/null | head -20 | while read file; do
        if grep -q "solgalaxy\|claim-reward" "$file" 2>/dev/null; then
            echo "   âš ï¸  TROUVÃ‰ dans: $file"
            grep -o "claim-reward.solgalaxy.cc" "$file" | head -1
        fi
    done
fi

# 3. VÃ©rifier les fichiers publics
echo ""
echo "3ï¸âƒ£ VÃ©rification des fichiers publics..."
find public -type f \( -name "*.html" -o -name "*.js" \) 2>/dev/null | while read file; do
    if grep -q "solgalaxy\|claim-reward" "$file" 2>/dev/null; then
        echo "   âš ï¸  TROUVÃ‰ dans: $file"
    fi
done

# 4. VÃ©rifier les fichiers source
echo ""
echo "4ï¸âƒ£ VÃ©rification des fichiers source..."
grep -r "solgalaxy\|claim-reward" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null && echo "   âš ï¸  TROUVÃ‰ dans le code source !" || echo "   âœ… Code source propre"

# 5. VÃ©rifier les variables d'environnement
echo ""
echo "5ï¸âƒ£ VÃ©rification des fichiers .env..."
for envfile in .env .env.local .env.production .env.production.local; do
    if [ -f "$envfile" ]; then
        if grep -qi "solgalaxy\|claim-reward" "$envfile" 2>/dev/null; then
            echo "   âš ï¸  TROUVÃ‰ dans: $envfile"
        fi
    fi
done

# 6. VÃ©rifier la base de donnÃ©es (settings)
echo ""
echo "6ï¸âƒ£ VÃ©rification de la base de donnÃ©es (settings)..."
if command -v sqlite3 &> /dev/null && [ -f prisma/dev.db ]; then
    sqlite3 prisma/dev.db "SELECT * FROM Settings WHERE stripeTestPk LIKE '%solgalaxy%' OR stripeTestSk LIKE '%solgalaxy%';" 2>/dev/null && echo "   âš ï¸  TROUVÃ‰ dans la base de donnÃ©es !" || echo "   âœ… Base de donnÃ©es propre"
elif [ -n "$DATABASE_URL" ]; then
    echo "   â„¹ï¸  Base de donnÃ©es PostgreSQL/MySQL - vÃ©rifiez manuellement"
fi

# 7. VÃ©rifier les middlewares
echo ""
echo "7ï¸âƒ£ VÃ©rification des middlewares..."
find . -name "middleware.*" -type f 2>/dev/null | while read file; do
    if grep -q "solgalaxy\|claim-reward" "$file" 2>/dev/null; then
        echo "   âš ï¸  TROUVÃ‰ dans: $file"
    fi
done

# 8. VÃ©rifier next.config
echo ""
echo "8ï¸âƒ£ VÃ©rification de next.config..."
if [ -f next.config.ts ] || [ -f next.config.js ]; then
    grep -q "solgalaxy\|claim-reward" next.config.* 2>/dev/null && echo "   âš ï¸  TROUVÃ‰ dans next.config !" || echo "   âœ… next.config propre"
fi

# 9. VÃ©rifier les headers HTTP
echo ""
echo "9ï¸âƒ£ Test de la rÃ©ponse HTTP..."
echo "   Test avec curl..."
curl -I https://preprod.bbservicescharter.com 2>&1 | grep -i "location\|redirect" || echo "   Pas de redirection dans les headers"

echo ""
echo "âœ… Scan terminÃ© !"





















