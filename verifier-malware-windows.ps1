# Script de verification de malware pour Windows
# Usage: powershell -ExecutionPolicy Bypass -File verifier-malware-windows.ps1

Write-Host "ðŸ” VERIFICATION DE MALWARE SUR WINDOWS" -ForegroundColor Cyan
Write-Host "=====================================" -ForegroundColor Cyan
Write-Host ""

$RED = "Red"
$GREEN = "Green"
$YELLOW = "Yellow"
$FOUND_ISSUES = $false
$ISSUES = @()

# 1. Verifier les processus malveillants
Write-Host "1ï¸âƒ£ Verification des processus..." -ForegroundColor Yellow
$SUSPICIOUS_PROCESSES = Get-Process | Where-Object {
    $_.ProcessName -match "(xmrig|moneroocean|systemwatcher|scanner_linux|miner)" -or
    $_.Path -match "(xmrig|moneroocean|systemwatcher|scanner_linux|miner)"
}

if ($SUSPICIOUS_PROCESSES) {
    Write-Host "ðŸš¨ Processus malveillants detectes !" -ForegroundColor $RED
    $SUSPICIOUS_PROCESSES | ForEach-Object {
        Write-Host "   - $($_.ProcessName) (PID: $($_.Id)) - $($_.Path)" -ForegroundColor $RED
        $ISSUES += "Processus: $($_.ProcessName) (PID: $($_.Id)) - $($_.Path)"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucun processus malveillant detecte" -ForegroundColor $GREEN
}
Write-Host ""

# 2. Verifier les fichiers suspects
Write-Host "2ï¸âƒ£ Verification des fichiers suspects..." -ForegroundColor Yellow
$SUSPICIOUS_PATTERNS = @("xmrig", "moneroocean", "systemwatcher", "scanner_linux", "1utig", "178.16.52.253")
$SEARCH_PATHS = @(
    "$env:USERPROFILE\Downloads",
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\Documents",
    "$env:TEMP",
    "$env:LOCALAPPDATA\Temp"
)

$SUSPICIOUS_FILES = @()
foreach ($path in $SEARCH_PATHS) {
    if (Test-Path $path) {
        foreach ($pattern in $SUSPICIOUS_PATTERNS) {
            $files = Get-ChildItem -Path $path -Recurse -ErrorAction SilentlyContinue | Where-Object {
                $_.Name -match $pattern -or $_.FullName -match $pattern
            }
            if ($files) {
                $SUSPICIOUS_FILES += $files
            }
        }
    }
}

if ($SUSPICIOUS_FILES) {
    Write-Host "ðŸš¨ Fichiers suspects trouves !" -ForegroundColor $RED
    $SUSPICIOUS_FILES | ForEach-Object {
        Write-Host "   - $($_.FullName)" -ForegroundColor $RED
        $ISSUES += "Fichier: $($_.FullName)"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucun fichier suspect trouve" -ForegroundColor $GREEN
}
Write-Host ""

# 3. Verifier les taches planifiees
Write-Host "3ï¸âƒ£ Verification des taches planifiees..." -ForegroundColor Yellow
$SUSPICIOUS_TASKS = @()
Get-ScheduledTask | ForEach-Object {
    $task = $_
    $isSuspicious = $false
    if ($task.TaskName -match "xmrig|moneroocean|miner|1utig") {
        $isSuspicious = $true
    } else {
        try {
            $taskActions = $task.Actions
            foreach ($action in $taskActions) {
                if ($action.Execute -match "wget|curl" -and $action.Arguments -match "http.*sh") {
                    $isSuspicious = $true
                    break
                }
                if ($action.Arguments -match "178.16.52.253|1utig") {
                    $isSuspicious = $true
                    break
                }
            }
        } catch {}
    }
    if ($isSuspicious) {
        $SUSPICIOUS_TASKS += $task
    }
}

if ($SUSPICIOUS_TASKS) {
    Write-Host "ðŸš¨ Taches planifiees suspectes trouvees !" -ForegroundColor $RED
    $SUSPICIOUS_TASKS | ForEach-Object {
        Write-Host "   - $($_.TaskName)" -ForegroundColor $RED
        $ISSUES += "Tache planifiee: $($_.TaskName)"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucune tache planifiee suspecte" -ForegroundColor $GREEN
}
Write-Host ""

# 4. Verifier les services Windows
Write-Host "4ï¸âƒ£ Verification des services Windows..." -ForegroundColor Yellow
$SUSPICIOUS_SERVICES = Get-Service | Where-Object {
    $_.Name -match "(xmrig|moneroocean|miner)" -or
    $_.DisplayName -match "(xmrig|moneroocean|miner)"
}

if ($SUSPICIOUS_SERVICES) {
    Write-Host "ðŸš¨ Services suspects trouves !" -ForegroundColor $RED
    $SUSPICIOUS_SERVICES | ForEach-Object {
        Write-Host "   - $($_.Name) ($($_.DisplayName))" -ForegroundColor $RED
        $ISSUES += "Service: $($_.Name) ($($_.DisplayName))"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucun service suspect" -ForegroundColor $GREEN
}
Write-Host ""

# 5. Verifier les connexions reseau suspectes
Write-Host "5ï¸âƒ£ Verification des connexions reseau..." -ForegroundColor Yellow
$SUSPICIOUS_CONNECTIONS = Get-NetTCPConnection -ErrorAction SilentlyContinue | Where-Object {
    $_.RemoteAddress -eq "178.16.52.253" -or
    $_.RemoteAddress -match "178\.16\.52\.253"
}

if ($SUSPICIOUS_CONNECTIONS) {
    Write-Host "ðŸš¨ Connexions reseau suspectes detectees !" -ForegroundColor $RED
    $SUSPICIOUS_CONNECTIONS | ForEach-Object {
        $process = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
        Write-Host "   - Connexion vers $($_.RemoteAddress):$($_.RemotePort) (PID: $($_.OwningProcess) - $($process.ProcessName))" -ForegroundColor $RED
        $ISSUES += "Connexion: $($_.RemoteAddress):$($_.RemotePort) (PID: $($_.OwningProcess))"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucune connexion suspecte" -ForegroundColor $GREEN
}
Write-Host ""

# 6. Verifier les fichiers de demarrage
Write-Host "6ï¸âƒ£ Verification des fichiers de demarrage..." -ForegroundColor Yellow
$STARTUP_PATHS = @(
    "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup",
    "$env:PROGRAMDATA\Microsoft\Windows\Start Menu\Programs\Startup",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
    "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
)

$SUSPICIOUS_STARTUP = @()
foreach ($startupPath in $STARTUP_PATHS) {
    if ($startupPath -match "^HK") {
        # Registre
        try {
            $regItems = Get-ItemProperty -Path $startupPath -ErrorAction SilentlyContinue
            if ($regItems) {
                $regItems.PSObject.Properties | Where-Object {
                    $_.Name -ne "PSPath" -and $_.Name -ne "PSParentPath" -and $_.Value
                } | Where-Object {
                    $val = $_.Value
                    if ($val) {
                        ($val -match "xmrig|moneroocean|miner|1utig" -or $val -match "178\.16\.52\.253") -or
                        ($val -match "wget|curl" -and $val -match "http.*sh")
                    } else {
                        $false
                    }
                } | ForEach-Object {
                    $SUSPICIOUS_STARTUP += "Registre $startupPath : $($_.Name) = $($_.Value)"
                }
            }
        } catch {}
    } else {
        # Dossier
        if (Test-Path $startupPath) {
            Get-ChildItem -Path $startupPath -ErrorAction SilentlyContinue | Where-Object {
                $_.Name -match "(xmrig|moneroocean|miner|1utig)" -or
                $_.FullName -match "(xmrig|moneroocean|miner|1utig)"
            } | ForEach-Object {
                $SUSPICIOUS_STARTUP += $_.FullName
            }
        }
    }
}

if ($SUSPICIOUS_STARTUP) {
    Write-Host "ðŸš¨ Fichiers de demarrage suspects trouves !" -ForegroundColor $RED
    $SUSPICIOUS_STARTUP | ForEach-Object {
        Write-Host "   - $_" -ForegroundColor $RED
        $ISSUES += "Demarrage: $_"
    }
    $FOUND_ISSUES = $true
} else {
    Write-Host "âœ… Aucun fichier de demarrage suspect" -ForegroundColor $GREEN
}
Write-Host ""

# 7. Verifier l utilisation CPU/Memoire suspecte
Write-Host "7ï¸âƒ£ Verification de l utilisation des ressources..." -ForegroundColor Yellow
$HIGH_CPU = Get-Process | Where-Object {
    $_.CPU -gt 50 -and
    ($_.ProcessName -notmatch "(chrome|firefox|edge|code|explorer|dwm|winlogon|csrss|svchost|dllhost)")
} | Sort-Object CPU -Descending | Select-Object -First 5

if ($HIGH_CPU) {
    Write-Host "âš ï¸ Processus avec utilisation CPU elevee :" -ForegroundColor $YELLOW
    $HIGH_CPU | ForEach-Object {
        Write-Host "   - $($_.ProcessName) : $([math]::Round($_.CPU, 2))% CPU" -ForegroundColor $YELLOW
    }
} else {
    Write-Host "âœ… Utilisation CPU normale" -ForegroundColor $GREEN
}
Write-Host ""

# 8. Verifier les fichiers recents suspects dans les dossiers systeme
Write-Host "8ï¸âƒ£ Verification des fichiers recents suspects..." -ForegroundColor Yellow
$RECENT_SUSPICIOUS = Get-ChildItem -Path $env:TEMP -ErrorAction SilentlyContinue | Where-Object {
    $_.LastWriteTime -gt (Get-Date).AddDays(-7) -and
    ($_.Name -match "(\.sh$|\.bat$|\.cmd$|\.ps1$)" -or $_.Name -match "(xmrig|moneroocean|miner|1utig)")
} | Sort-Object LastWriteTime -Descending | Select-Object -First 10

if ($RECENT_SUSPICIOUS) {
    Write-Host "âš ï¸ Fichiers recents suspects dans TEMP :" -ForegroundColor $YELLOW
    $RECENT_SUSPICIOUS | ForEach-Object {
        Write-Host "   - $($_.Name) (Modifie: $($_.LastWriteTime))" -ForegroundColor $YELLOW
    }
} else {
    Write-Host "âœ… Aucun fichier recent suspect" -ForegroundColor $GREEN
}
Write-Host ""

# Resume
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
Write-Host ""

if ($FOUND_ISSUES) {
    Write-Host "ðŸš¨ PROBLEMES DETECTES !" -ForegroundColor $RED
    Write-Host ""
    Write-Host "Actions recommandees :" -ForegroundColor $YELLOW
    Write-Host "1. Arretez les processus malveillants :" -ForegroundColor $YELLOW
    Write-Host "   Get-Process | Where-Object {`$_.ProcessName -match `"xmrig|moneroocean|miner`" } | Stop-Process -Force" -ForegroundColor White
    Write-Host ""
    Write-Host "2. Supprimez les fichiers suspects manuellement" -ForegroundColor $YELLOW
    Write-Host ""
    Write-Host "3. Supprimez les taches planifiees suspectes :" -ForegroundColor $YELLOW
    Write-Host "   Unregister-ScheduledTask -TaskName NOM_DE_LA_TACHE -Confirm:`$false" -ForegroundColor White
    Write-Host ""
    Write-Host "4. Executez un scan antivirus complet" -ForegroundColor $YELLOW
    Write-Host ""
    Write-Host "5. Redemarrez votre ordinateur" -ForegroundColor $YELLOW
    Write-Host ""
    
    # Sauvegarder le rapport
    $dateStr = Get-Date -Format "yyyy-MM-dd-HHmmss"
    $REPORT_PATH = "$env:USERPROFILE\Desktop\rapport-malware-$dateStr.txt"
    $ISSUES | Out-File -FilePath $REPORT_PATH -Encoding UTF8
    Write-Host "ðŸ“„ Rapport sauvegarde : $REPORT_PATH" -ForegroundColor Cyan
    
    exit 1
} else {
    Write-Host "âœ… AUCUN MALWARE DETECTE !" -ForegroundColor $GREEN
    Write-Host ""
    Write-Host "Votre systeme semble propre." -ForegroundColor $GREEN
    Write-Host ""
    Write-Host "Recommandations :" -ForegroundColor $YELLOW
    Write-Host "- Executez ce script regulierement (hebdomadaire)" -ForegroundColor White
    Write-Host "- Gardez votre antivirus a jour" -ForegroundColor White
    Write-Host "- Evitez dexecuter des scripts non verifies" -ForegroundColor White
    Write-Host ""
    exit 0
}

